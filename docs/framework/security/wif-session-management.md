---
title: Gestione delle sessioni WIF
ms.date: 03/30/2017
ms.assetid: 98bce126-18a9-401b-b20d-67ee462a5f8a
author: BrucePerlerMS
ms.openlocfilehash: 141eda509530cab1120d519c3cbc94693ef1cc51
ms.sourcegitcommit: 68653db98c5ea7744fd438710248935f70020dfb
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/22/2019
ms.locfileid: "69946229"
---
# <a name="wif-session-management"></a><span data-ttu-id="2a657-102">Gestione delle sessioni WIF</span><span class="sxs-lookup"><span data-stu-id="2a657-102">WIF Session Management</span></span>
<span data-ttu-id="2a657-103">Quando un client tenta di accedere per la prima volta a una risorsa protetta ospitata da una relying party, deve prima di tutto autenticarsi in un servizio token di sicurezza considerato attendibile dalla relying party.</span><span class="sxs-lookup"><span data-stu-id="2a657-103">When a client first tries to access a protected resource that is hosted by a relying party, the client must first authenticate itself to a security token service (STS) that is trusted by the relying party.</span></span> <span data-ttu-id="2a657-104">Il servizio token di sicurezza rilascia quindi un token di sicurezza al client.</span><span class="sxs-lookup"><span data-stu-id="2a657-104">The STS then issues a security token to the client.</span></span> <span data-ttu-id="2a657-105">Il client presenta questo token alla relying party, che quindi concede al client l'accesso alla risorsa protetta.</span><span class="sxs-lookup"><span data-stu-id="2a657-105">The client presents this token to the relying party, which then grants the client access to the protected resource.</span></span> <span data-ttu-id="2a657-106">Non si vuole, tuttavia, che il client debba eseguire una nuova autenticazione nel servizio token di sicurezza per ogni richiesta, in particolare perché potrebbe anche non trovarsi nello stesso computer o nello stesso dominio della relying party.</span><span class="sxs-lookup"><span data-stu-id="2a657-106">However, you don’t want the client to have to re-authenticate to the STS for each request, especially because it might not even be on the same computer or in the same domain as the relying party.</span></span> <span data-ttu-id="2a657-107">Windows Identity Foundation (WIF) fa invece in modo che il client e la relying party stabiliscano una sessione nella quale il client usa un token di sicurezza della sessione per autenticarsi nella relying party per tutte le richieste successive alla prima.</span><span class="sxs-lookup"><span data-stu-id="2a657-107">Instead, Windows Identity Foundation (WIF) has the client and relying party establish a session in which the client uses a session security token to authenticate itself to the relying party for all requests after the first request.</span></span> <span data-ttu-id="2a657-108">La relying party può usare questo token di sicurezza della sessione, archiviato all'interno di un cookie, per ricostruire l'oggetto <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType> del client.</span><span class="sxs-lookup"><span data-stu-id="2a657-108">The relying party can use this session security token, which is stored inside a cookie, to reconstruct the client’s <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>.</span></span>  
  
 <span data-ttu-id="2a657-109">Il servizio token di sicurezza definisce il tipo di autenticazione che il client deve fornire.</span><span class="sxs-lookup"><span data-stu-id="2a657-109">The STS defines what authentication the client must provide.</span></span> <span data-ttu-id="2a657-110">Il client può tuttavia avere più credenziali con le quali può autenticarsi nel servizio token di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="2a657-110">However, the client might have multiple credentials with which it can authenticate itself to the STS.</span></span> <span data-ttu-id="2a657-111">Può ad esempio avere un token di Windows Live, un nome utente e una password, un certificato e una smartkey.</span><span class="sxs-lookup"><span data-stu-id="2a657-111">For example, it might have a token from Windows Live, a user name and password, a certificate, and a smartkey.</span></span> <span data-ttu-id="2a657-112">In tal caso, il servizio token di sicurezza concede diverse identità al client, ognuna delle quali corrisponde a una delle credenziali presentate dal client.</span><span class="sxs-lookup"><span data-stu-id="2a657-112">In that case, the STS grants the client several identities, with each identity corresponding to one of the credentials that the client presents.</span></span> <span data-ttu-id="2a657-113">La relying party può usare una o più di queste identità quando decide quale livello di accesso concedere al client.</span><span class="sxs-lookup"><span data-stu-id="2a657-113">The relying party can use one or more of these identities when it decides what level of access to grant the client.</span></span>  
  
 <span data-ttu-id="2a657-114"><xref:System.IdentityModel.Tokens.SessionSecurityToken?displayProperty=nameWithType> viene usato per ricostruire l'oggetto <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType> del client, contenente tutte le identità del client in <xref:System.Security.Claims.ClaimsPrincipal.Identities%2A>.</span><span class="sxs-lookup"><span data-stu-id="2a657-114">The <xref:System.IdentityModel.Tokens.SessionSecurityToken?displayProperty=nameWithType> is used to reconstruct the client’s <xref:System.Security.Claims.ClaimsPrincipal?displayProperty=nameWithType>, which contains all of the client’s identities in <xref:System.Security.Claims.ClaimsPrincipal.Identities%2A>.</span></span> <span data-ttu-id="2a657-115">Ogni oggetto <xref:System.Security.Claims.ClaimsIdentity?displayProperty=nameWithType> nella raccolta contiene i token di bootstrap associati a tale identità.</span><span class="sxs-lookup"><span data-stu-id="2a657-115">Each <xref:System.Security.Claims.ClaimsIdentity?displayProperty=nameWithType> in the collection contains the bootstrap tokens that are associated with that identity.</span></span>  
  
 <span data-ttu-id="2a657-116">Se viene rilasciato un nuovo token di sessione con l'ID sessione del token di sessione originale, <xref:System.IdentityModel.Tokens.SessionSecurityTokenHandler?displayProperty=nameWithType> non aggiorna il token di sessione nella cache dei token.</span><span class="sxs-lookup"><span data-stu-id="2a657-116">If a new session token is issued with the session ID of the original session token, <xref:System.IdentityModel.Tokens.SessionSecurityTokenHandler?displayProperty=nameWithType> does not update the session token in the token cache.</span></span> <span data-ttu-id="2a657-117">È consigliabile creare sempre un'istanza di un token di sessione con un ID sessione univoco.</span><span class="sxs-lookup"><span data-stu-id="2a657-117">You should always instantiate a session token with a unique session ID.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="2a657-118">Session.SecurityTokenHandler.ReadToken genera un'eccezione <xref:System.Xml.XmlException> se riceve input non valido, ad esempio se il cookie contenente il token di sessione è danneggiato.</span><span class="sxs-lookup"><span data-stu-id="2a657-118">Session.SecurityTokenHandler.ReadToken throws a <xref:System.Xml.XmlException> exception if it receives invalid input; for example, if the cookie that contains the session token is corrupted.</span></span> <span data-ttu-id="2a657-119">È consigliabile intercettare questa eccezione e fornire un comportamento specifico dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="2a657-119">We recommend that you catch this exception and provide application-specific behavior.</span></span>  
  
 <span data-ttu-id="2a657-120">Se una pagina Web protetta contiene numerose risorse (ad esempio, immagini di piccole dimensioni) che si trovano anche nel dominio protetto, il client deve eseguire di nuovo l'autenticazione nella relying party per scaricare ognuna di tali risorse.</span><span class="sxs-lookup"><span data-stu-id="2a657-120">If a protected Web page contains lots of resources (such as small graphics) that are also in the protected domain, the client must re-authenticate itself to the relying party to download each of those resources.</span></span> <span data-ttu-id="2a657-121">Se si usa un token di autenticazione della sessione non è necessario eseguire l'autenticazione nel servizio token di sicurezza per ogni richiesta, ma vengono comunque inviati numerosi cookie.</span><span class="sxs-lookup"><span data-stu-id="2a657-121">Use of a session authentication token avoids the need to authenticate to the STS for each request, but it still means that many cookies are being sent over.</span></span> <span data-ttu-id="2a657-122">È possibile configurare la pagina Web in modo che i dati e le risorse importanti vengano archiviati nel dominio protetto, mentre gli elementi secondari vengono archiviati in un dominio non protetto e ne viene inserito un collegamento dalla pagina Web principale.</span><span class="sxs-lookup"><span data-stu-id="2a657-122">You might want to set up the Web page so that the important data and resources are stored in the protected domain while minor items are stored in an unprotected domain and linked to from the main Web page.</span></span> <span data-ttu-id="2a657-123">Impostare inoltre il percorso dei cookie in modo da fare riferimento solo al dominio protetto.</span><span class="sxs-lookup"><span data-stu-id="2a657-123">Also, set the cookie path to reference only the protected domain.</span></span>  
  
 <span data-ttu-id="2a657-124">Per usare la modalità di riferimento, Microsoft consiglia di fornire un gestore per l'evento <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SessionSecurityTokenCreated> nel file **global.asax.cs** e di impostare la proprietà **IsReferenceMode** nel token passato nella proprietà <xref:System.IdentityModel.Services.SessionSecurityTokenCreatedEventArgs.SessionToken%2A>.</span><span class="sxs-lookup"><span data-stu-id="2a657-124">To operate in reference mode, Microsoft recommends providing a handler for the <xref:System.IdentityModel.Services.WSFederationAuthenticationModule.SessionSecurityTokenCreated> event in the **global.asax.cs** file and setting the **IsReferenceMode** property on the token passed in the <xref:System.IdentityModel.Services.SessionSecurityTokenCreatedEventArgs.SessionToken%2A> property.</span></span> <span data-ttu-id="2a657-125">Questi aggiornamenti garantiscono che il token di sessione funzioni in modalità di riferimento per ogni richiesta è ciò è preferibile rispetto a impostare semplicemente la proprietà <xref:System.IdentityModel.Services.SessionAuthenticationModule.IsReferenceMode%2A> nel modulo di autenticazione della sessione.</span><span class="sxs-lookup"><span data-stu-id="2a657-125">These updates will ensure that the session token operates in reference mode for every request and is favored over merely setting the  <xref:System.IdentityModel.Services.SessionAuthenticationModule.IsReferenceMode%2A> property on the Session Authentication Module.</span></span>  
  
## <a name="extensibility"></a><span data-ttu-id="2a657-126">Estendibilità</span><span class="sxs-lookup"><span data-stu-id="2a657-126">Extensibility</span></span>  
 <span data-ttu-id="2a657-127">È possibile estendere il meccanismo di gestione della sessione.</span><span class="sxs-lookup"><span data-stu-id="2a657-127">You can extend the session management mechanism.</span></span> <span data-ttu-id="2a657-128">In tal modo è possibile migliorare le prestazioni.</span><span class="sxs-lookup"><span data-stu-id="2a657-128">One reason for this would be to improve the performance.</span></span> <span data-ttu-id="2a657-129">È possibile, ad esempio, creare un gestore di cookie personalizzato che trasforma o ottimizza il token di sicurezza della sessione tra lo stato in memoria e ciò che viene inserito nel cookie.</span><span class="sxs-lookup"><span data-stu-id="2a657-129">For example, you could create a custom cookie handler that transforms or optimizes the session security token between its in-memory state and what goes into the cookie.</span></span> <span data-ttu-id="2a657-130">A tale scopo, è possibile configurare la proprietà <xref:System.IdentityModel.Services.SessionAuthenticationModule.CookieHandler%2A?displayProperty=nameWithType> di <xref:System.IdentityModel.Services.SessionAuthenticationModule?displayProperty=nameWithType> per usare un gestore di cookie personalizzato che deriva da <xref:System.IdentityModel.Services.CookieHandler?displayProperty=nameWithType>.</span><span class="sxs-lookup"><span data-stu-id="2a657-130">To do so, you can configure the <xref:System.IdentityModel.Services.SessionAuthenticationModule.CookieHandler%2A?displayProperty=nameWithType> property of the <xref:System.IdentityModel.Services.SessionAuthenticationModule?displayProperty=nameWithType> to use a custom cookie handler that derives from <xref:System.IdentityModel.Services.CookieHandler?displayProperty=nameWithType>.</span></span> <span data-ttu-id="2a657-131"><xref:System.IdentityModel.Services.ChunkedCookieHandler?displayProperty=nameWithType> è il gestore di cookie predefinito, perché i cookie superano la dimensione consentita per HTTP (Hypertext Transfer Protocol). Se si usa invece un gestore di cookie personalizzato, è necessario implementare la suddivisione in blocchi.</span><span class="sxs-lookup"><span data-stu-id="2a657-131"><xref:System.IdentityModel.Services.ChunkedCookieHandler?displayProperty=nameWithType> is the default cookie handler because the cookies exceed the allowable size for Hypertext Transfer Protocol (HTTP); if you use a custom cookie handler instead, you must implement chunking.</span></span>  
  
 <span data-ttu-id="2a657-132">Per ulteriori informazioni, vedere l'esempio [ClaimsAwareWebFarm](https://go.microsoft.com/fwlink/?LinkID=248408) .</span><span class="sxs-lookup"><span data-stu-id="2a657-132">For more information, see [ClaimsAwareWebFarm](https://go.microsoft.com/fwlink/?LinkID=248408) sample.</span></span> <span data-ttu-id="2a657-133">Questo esempio illustra un cache di sessione compatibile con la farm (in contrapposizione a tokenreplycache) grazie a cui è possibile usare le sessioni tramite riferimento invece di scambiare cookie di grandi dimensioni. L'esempio illustra anche un modo più semplice per proteggere i cookie in una farm.</span><span class="sxs-lookup"><span data-stu-id="2a657-133">This sample shows a farm ready session cache (as opposed to a tokenreplycache) so that you can use sessions by reference instead of exchanging big cookies; this sample also demonstrates an easier way of securing cookies in a farm.</span></span> <span data-ttu-id="2a657-134">La cache di sessione è basata su WCF.</span><span class="sxs-lookup"><span data-stu-id="2a657-134">The session cache is WCF-based.</span></span> <span data-ttu-id="2a657-135">Per quanto riguarda la protezione della sessione, l'esempio illustra una nuova funzionalità di WIF 4.5 relativa a una trasformazione di cookie basata su MachineKey, che è possibile attivare semplicemente incollando il frammento di codice appropriato in web.config. L'esempio non è inserito in un ambiente farm, ma illustra cosa occorre per rendere l'app compatibile con la farm.</span><span class="sxs-lookup"><span data-stu-id="2a657-135">With regard to session securing, the sample demonstrates a new capability in WIF 4.5 of a cookie transform based on MachineKey, which can be activated by simply pasting the appropriate snippet in the web.config. The sample itself is not "farmed", but it demonstrates what you need for making your app farm-ready.</span></span>
