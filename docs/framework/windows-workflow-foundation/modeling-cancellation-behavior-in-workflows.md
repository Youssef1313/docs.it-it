---
title: Modellazione del comportamento di annullamento nei flussi di lavoro
ms.date: 03/30/2017
ms.assetid: d48f6cf3-cdde-4dd3-8265-a665acf32a03
ms.openlocfilehash: ec0cf810693e2eda01a4c489b6eb938538719228
ms.sourcegitcommit: 68653db98c5ea7744fd438710248935f70020dfb
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/22/2019
ms.locfileid: "69965943"
---
# <a name="modeling-cancellation-behavior-in-workflows"></a><span data-ttu-id="14500-102">Modellazione del comportamento di annullamento nei flussi di lavoro</span><span class="sxs-lookup"><span data-stu-id="14500-102">Modeling Cancellation Behavior in Workflows</span></span>
<span data-ttu-id="14500-103">Le attività possono essere annullate all'interno di un flusso di lavoro, ad esempio da un'attività <xref:System.Activities.Statements.Parallel> che annulla i rami incompleti quando la proprietà <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> restituisce `true` oppure all'esterno del flusso di lavoro, se l'host chiama il metodo <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span><span class="sxs-lookup"><span data-stu-id="14500-103">Activities can be canceled inside a workflow, for example by a <xref:System.Activities.Statements.Parallel> activity canceling incomplete branches when its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> evaluates to `true`, or from outside the workflow, if the host calls <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span></span> <span data-ttu-id="14500-104">Per assicurare la gestione dell'annullamento, gli autori del flusso di lavoro possono usare le attività <xref:System.Activities.Statements.CancellationScope> e <xref:System.Activities.Statements.CompensableActivity> o creare attività personalizzate che forniscono la logica di annullamento.</span><span class="sxs-lookup"><span data-stu-id="14500-104">To provide cancellation handling, workflow authors can use the <xref:System.Activities.Statements.CancellationScope> activity, the <xref:System.Activities.Statements.CompensableActivity> activity, or create custom activities that provide cancellation logic.</span></span> <span data-ttu-id="14500-105">In questo argomento viene fornita una panoramica sull'annullamento nei flussi di lavoro.</span><span class="sxs-lookup"><span data-stu-id="14500-105">This topic provides an overview of cancellation in workflows.</span></span>  
  
## <a name="cancellation-compensation-and-transactions"></a><span data-ttu-id="14500-106">Annullamento, compensazione e transazioni</span><span class="sxs-lookup"><span data-stu-id="14500-106">Cancellation, Compensation, and Transactions</span></span>  
 <span data-ttu-id="14500-107">Le transazioni consentono all'applicazione di interrompere, ovvero eseguire il rollback, tutte le modifiche eseguite all'interno della transazione se si verificano errori durante qualsiasi parte del processo di transazione.</span><span class="sxs-lookup"><span data-stu-id="14500-107">Transactions give your application the ability to abort (roll back) all changes executed within the transaction if any errors occur during any part of the transaction process.</span></span> <span data-ttu-id="14500-108">Tuttavia, non tutte le operazioni che potrebbero dover essere annullate sono appropriate per le transazioni, ad esempio operazioni con esecuzione prolungata o che non implicano risorse transazionali.</span><span class="sxs-lookup"><span data-stu-id="14500-108">However, not all work that may need to be canceled or undone is appropriate for transactions, such as long-running work or work that does not involve transactional resources.</span></span> <span data-ttu-id="14500-109">La compensazione fornisce un modello per annullare operazioni non transazionali completate precedentemente se, in seguito, si verifica un errore nel flusso di lavoro.</span><span class="sxs-lookup"><span data-stu-id="14500-109">Compensation provides a model for undoing previously completed non-transactional work if there is a subsequent failure in the workflow.</span></span> <span data-ttu-id="14500-110">L'annullamento fornisce agli autori di flussi di lavoro e attività un modello per gestire le operazioni non transazionali che non sono state completate.</span><span class="sxs-lookup"><span data-stu-id="14500-110">Cancellation provides a model for workflow and activity authors to handle non-transactional work that was not completed.</span></span> <span data-ttu-id="14500-111">Se l'attività viene annullata poiché non ne è stata completata l'esecuzione, sarà richiamata la relativa logica di annullamento, se disponibile.</span><span class="sxs-lookup"><span data-stu-id="14500-111">If an activity has not completed its execution and it is canceled, its cancellation logic will be invoked if it is available.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="14500-112">Per ulteriori informazioni sulle transazioni e sulla compensazione, vedere [transazioni](workflow-transactions.md) e [compensazione](compensation.md).</span><span class="sxs-lookup"><span data-stu-id="14500-112">For more information about transactions and compensation, see [Transactions](workflow-transactions.md) and [Compensation](compensation.md).</span></span>  
  
## <a name="using-cancellationscope"></a><span data-ttu-id="14500-113">Utilizzo dell'attività CancellationScope</span><span class="sxs-lookup"><span data-stu-id="14500-113">Using CancellationScope</span></span>  
 <span data-ttu-id="14500-114">L'attività <xref:System.Activities.Statements.CancellationScope> dispone di due sezioni che possono contenere le attività figlio <xref:System.Activities.Statements.CancellationScope.Body%2A> e <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>.</span><span class="sxs-lookup"><span data-stu-id="14500-114">The <xref:System.Activities.Statements.CancellationScope> activity has two sections that can contain child activities: <xref:System.Activities.Statements.CancellationScope.Body%2A> and <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>.</span></span> <span data-ttu-id="14500-115">Nella proprietà <xref:System.Activities.Statements.CancellationScope.Body%2A> vengono posizionate le attività che costituiscono la logica dell'attività e nella proprietà <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> vengono posizionate le attività che forniscono la logica di annullamento per l'attività.</span><span class="sxs-lookup"><span data-stu-id="14500-115">The <xref:System.Activities.Statements.CancellationScope.Body%2A> is where the activities that make up the logic of the activity are placed, and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> is where the activities that provide cancellation logic for the activity are placed.</span></span> <span data-ttu-id="14500-116">Un'attività può essere annullata solo se non è stata completata.</span><span class="sxs-lookup"><span data-stu-id="14500-116">An activity can be canceled only if it has not completed.</span></span> <span data-ttu-id="14500-117">Nel caso dell'attività <xref:System.Activities.Statements.CancellationScope>, con completamento si intende il completamento delle attività nella proprietà <xref:System.Activities.Statements.CancellationScope.Body%2A>.</span><span class="sxs-lookup"><span data-stu-id="14500-117">In the case of the <xref:System.Activities.Statements.CancellationScope> activity, completion refers to the completion of the activities in the <xref:System.Activities.Statements.CancellationScope.Body%2A>.</span></span> <span data-ttu-id="14500-118">Se viene pianificata una richiesta di annullamento e le attività nella proprietà <xref:System.Activities.Statements.CancellationScope.Body%2A> non sono state completate, l'attività <xref:System.Activities.Statements.CancellationScope> sarà contrassegnata come <xref:System.Activities.ActivityInstanceState.Canceled> e saranno eseguite le attività della proprietà <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>.</span><span class="sxs-lookup"><span data-stu-id="14500-118">If a cancellation request is scheduled and the activities in the <xref:System.Activities.Statements.CancellationScope.Body%2A> have not completed, then the <xref:System.Activities.Statements.CancellationScope> will be marked as <xref:System.Activities.ActivityInstanceState.Canceled> and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> activities will be executed.</span></span>  
  
### <a name="canceling-a-workflow-from-the-host"></a><span data-ttu-id="14500-119">Annullamento di un flusso di lavoro dall'host</span><span class="sxs-lookup"><span data-stu-id="14500-119">Canceling a Workflow from the Host</span></span>  
 <span data-ttu-id="14500-120">Un host può annullare un flusso di lavoro chiamando il metodo <xref:System.Activities.WorkflowApplication.Cancel%2A> dell'istanza <xref:System.Activities.WorkflowApplication> che sta ospitando il flusso di lavoro.</span><span class="sxs-lookup"><span data-stu-id="14500-120">A host can cancel a workflow by calling the <xref:System.Activities.WorkflowApplication.Cancel%2A> method of the <xref:System.Activities.WorkflowApplication> instance that is hosting the workflow.</span></span> <span data-ttu-id="14500-121">Nell'esempio seguente, viene creato un flusso di lavoro che dispone di un'attività <xref:System.Activities.Statements.CancellationScope>.</span><span class="sxs-lookup"><span data-stu-id="14500-121">In the following example a workflow is created that has a <xref:System.Activities.Statements.CancellationScope>.</span></span> <span data-ttu-id="14500-122">Una volta richiamato il flusso di lavoro, l'host effettua una chiamata al metodo <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span><span class="sxs-lookup"><span data-stu-id="14500-122">The workflow is invoked, and then the host makes a call to <xref:System.Activities.WorkflowApplication.Cancel%2A>.</span></span> <span data-ttu-id="14500-123">L'esecuzione principale del flusso di lavoro viene interrotta, viene richiamata la proprietà <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> dell'attività <xref:System.Activities.Statements.CancellationScope>, quindi il flusso di lavoro viene completato con lo stato <xref:System.Activities.ActivityInstanceState.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="14500-123">The main execution of the workflow is stopped, the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of the <xref:System.Activities.Statements.CancellationScope> is invoked, and then the workflow completes with a status of <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#35](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#35)]  
  
 <span data-ttu-id="14500-124">Quando questo flusso di lavoro viene richiamato, nella console viene visualizzato l'output seguente.</span><span class="sxs-lookup"><span data-stu-id="14500-124">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="14500-125">**Avvio del flusso di lavoro.**</span><span class="sxs-lookup"><span data-stu-id="14500-125">**Starting the workflow.**</span></span>  
<span data-ttu-id="14500-126">**CancellationHandler richiamato.**  </span><span class="sxs-lookup"><span data-stu-id="14500-126">**CancellationHandler invoked.** </span></span>  
<span data-ttu-id="14500-127">**Flusso di lavoro b30ebb30-df46-4d90-A211-e31c38d8db3c annullato.**</span><span class="sxs-lookup"><span data-stu-id="14500-127">**Workflow b30ebb30-df46-4d90-a211-e31c38d8db3c Canceled.**</span></span>    
> [!NOTE]
> <span data-ttu-id="14500-128">Quando un'attività <xref:System.Activities.Statements.CancellationScope> viene annullata e viene richiamata la proprietà <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>, l'autore del flusso di lavoro deve determinare lo stato dell'attività prima del relativo annullamento al fine di fornire la logica di annullamento appropriata.</span><span class="sxs-lookup"><span data-stu-id="14500-128">When a <xref:System.Activities.Statements.CancellationScope> activity is canceled and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> invoked, it is the responsibility of the workflow author to determine the progress that the canceled activity made before it was canceled in order to provide the appropriate cancellation logic.</span></span> <span data-ttu-id="14500-129">La proprietà <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> non fornisce alcuna informazione sullo stato dell'attività annullata.</span><span class="sxs-lookup"><span data-stu-id="14500-129">The <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> does not provide any information about the progress of the canceled activity.</span></span>  
  
 <span data-ttu-id="14500-130">Un flusso di lavoro può essere annullato anche dall'host se un'eccezione non gestita viene propagata oltre la radice del flusso di lavoro e il gestore della proprietà <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> restituisce <xref:System.Activities.UnhandledExceptionAction.Cancel>.</span><span class="sxs-lookup"><span data-stu-id="14500-130">A workflow can also be canceled from the host if an unhandled exception bubbles up past the root of the workflow and the <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> handler returns <xref:System.Activities.UnhandledExceptionAction.Cancel>.</span></span> <span data-ttu-id="14500-131">In questo esempio, viene avviato il flusso di lavoro che, successivamente, genera un'eccezione <xref:System.ApplicationException>.</span><span class="sxs-lookup"><span data-stu-id="14500-131">In this example the workflow starts and then throws an <xref:System.ApplicationException>.</span></span> <span data-ttu-id="14500-132">Questa eccezione non viene gestita dal flusso di lavoro, pertanto viene richiamato il gestore della proprietà <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A>.</span><span class="sxs-lookup"><span data-stu-id="14500-132">This exception is unhandled by the workflow and so the <xref:System.Activities.WorkflowApplication.OnUnhandledException%2A> handler is invoked.</span></span> <span data-ttu-id="14500-133">Il gestore indica al runtime di annullare il flusso di lavoro e viene richiamata la proprietà <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> dell'attività <xref:System.Activities.Statements.CancellationScope> attualmente in corso di esecuzione.</span><span class="sxs-lookup"><span data-stu-id="14500-133">The handler instructs the runtime to cancel the workflow, and the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of the currently executing <xref:System.Activities.Statements.CancellationScope> activity is invoked.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#36](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#36)]  
  
 <span data-ttu-id="14500-134">Quando questo flusso di lavoro viene richiamato, nella console viene visualizzato l'output seguente.</span><span class="sxs-lookup"><span data-stu-id="14500-134">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="14500-135">**Avvio del flusso di lavoro.**</span><span class="sxs-lookup"><span data-stu-id="14500-135">**Starting the workflow.**</span></span>  
<span data-ttu-id="14500-136">**OnUnhandledException in 6bb2d5d6-f49a-4c6d-a988-478afb86dbe9 del flusso di lavoro** </span><span class="sxs-lookup"><span data-stu-id="14500-136">**OnUnhandledException in Workflow 6bb2d5d6-f49a-4c6d-a988-478afb86dbe9** </span></span>  
<span data-ttu-id="14500-137">**È stata generata un'eccezione ApplicationException.**  </span><span class="sxs-lookup"><span data-stu-id="14500-137">**An ApplicationException was thrown.** </span></span>  
<span data-ttu-id="14500-138">**CancellationHandler richiamato.**  </span><span class="sxs-lookup"><span data-stu-id="14500-138">**CancellationHandler invoked.** </span></span>  
<span data-ttu-id="14500-139">**Flusso di lavoro 6bb2d5d6-f49a-4c6d-a988-478afb86dbe9 annullato.**</span><span class="sxs-lookup"><span data-stu-id="14500-139">**Workflow 6bb2d5d6-f49a-4c6d-a988-478afb86dbe9 Canceled.**</span></span>    
### <a name="canceling-an-activity-from-inside-a-workflow"></a><span data-ttu-id="14500-140">Annullamento di un'attività dall'interno di un flusso di lavoro</span><span class="sxs-lookup"><span data-stu-id="14500-140">Canceling an Activity from Inside a Workflow</span></span>  
 <span data-ttu-id="14500-141">Un'attività può essere annullata anche dal relativo elemento padre.</span><span class="sxs-lookup"><span data-stu-id="14500-141">An activity can also be canceled by its parent.</span></span> <span data-ttu-id="14500-142">Ad esempio, se un'attività <xref:System.Activities.Statements.Parallel> dispone di più rami in esecuzione e la relativa proprietà <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> restituisce `true`, i rami incompleti corrispondenti saranno annullati.</span><span class="sxs-lookup"><span data-stu-id="14500-142">For example, if a <xref:System.Activities.Statements.Parallel> activity has multiple executing branches and its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> evaluates to `true` then its incomplete branches will be canceled.</span></span> <span data-ttu-id="14500-143">In questo esempio viene creata un'attività <xref:System.Activities.Statements.Parallel> che dispone di due rami.</span><span class="sxs-lookup"><span data-stu-id="14500-143">In this example a <xref:System.Activities.Statements.Parallel> activity is created that has two branches.</span></span> <span data-ttu-id="14500-144">La relativa proprietà <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> è impostata su `true`, pertanto l'oggetto <xref:System.Activities.Statements.Parallel> viene completato non appena si verifica la stessa condizione per uno dei relativi rami.</span><span class="sxs-lookup"><span data-stu-id="14500-144">Its <xref:System.Activities.Statements.Parallel.CompletionCondition%2A> is set to `true` so the <xref:System.Activities.Statements.Parallel> completes as soon as any one of its branches is completed.</span></span> <span data-ttu-id="14500-145">In questo esempio viene completato il ramo 2, pertanto il ramo 1 viene annullato.</span><span class="sxs-lookup"><span data-stu-id="14500-145">In this example branch 2 completes, and so branch 1 is canceled.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#37](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#37)]  
  
 <span data-ttu-id="14500-146">Quando questo flusso di lavoro viene richiamato, nella console viene visualizzato l'output seguente.</span><span class="sxs-lookup"><span data-stu-id="14500-146">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="14500-147">**Inizio del ramo 1.**</span><span class="sxs-lookup"><span data-stu-id="14500-147">**Branch 1 starting.**</span></span>  
<span data-ttu-id="14500-148">**Ramo 2 completato.**  </span><span class="sxs-lookup"><span data-stu-id="14500-148">**Branch 2 complete.** </span></span>  
<span data-ttu-id="14500-149">**Ramo 1 annullato.**  </span><span class="sxs-lookup"><span data-stu-id="14500-149">**Branch 1 canceled.** </span></span>  
<span data-ttu-id="14500-150">**E0685e24-18ef-4A47-acf3-5c638732f3be del flusso di lavoro completato.**</span><span class="sxs-lookup"><span data-stu-id="14500-150">**Workflow e0685e24-18ef-4a47-acf3-5c638732f3be Completed.**</span></span>  <span data-ttu-id="14500-151">Le attività vengono annullate anche se un'eccezione viene propagata oltre la radice dell'attività, ma viene gestita a un livello superiore nel flusso di lavoro.</span><span class="sxs-lookup"><span data-stu-id="14500-151">Activities are also canceled if an exception bubbles up past the root of the activity but is handled at a higher level in the workflow.</span></span> <span data-ttu-id="14500-152">In questo esempio la logica principale del flusso di lavoro è costituita da un'attività <xref:System.Activities.Statements.Sequence>.</span><span class="sxs-lookup"><span data-stu-id="14500-152">In this example, the main logic of the workflow consists of a <xref:System.Activities.Statements.Sequence> activity.</span></span> <span data-ttu-id="14500-153"><xref:System.Activities.Statements.Sequence> è specificato come  <xref:System.Activities.Statements.CancellationScope.Body%2A> di un'attività <xref:System.Activities.Statements.CancellationScope> che è contenuta da un'attività <xref:System.Activities.Statements.TryCatch>.</span><span class="sxs-lookup"><span data-stu-id="14500-153">The <xref:System.Activities.Statements.Sequence> is specified as the <xref:System.Activities.Statements.CancellationScope.Body%2A> of a <xref:System.Activities.Statements.CancellationScope> activity which is contained by a <xref:System.Activities.Statements.TryCatch> activity.</span></span> <span data-ttu-id="14500-154">Dal corpo dell'attività <xref:System.Activities.Statements.Sequence> viene generata un'eccezione che viene gestita dall'attività padre <xref:System.Activities.Statements.TryCatch>. L'attività <xref:System.Activities.Statements.Sequence> viene quindi annullata.</span><span class="sxs-lookup"><span data-stu-id="14500-154">An exception is thrown from the body of the <xref:System.Activities.Statements.Sequence>, is handled by the parent <xref:System.Activities.Statements.TryCatch> activity, and the <xref:System.Activities.Statements.Sequence> is canceled.</span></span>  
  
 [!code-csharp[CFX_WorkflowApplicationExample#39](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#39)]  
  
 <span data-ttu-id="14500-155">Quando questo flusso di lavoro viene richiamato, nella console viene visualizzato l'output seguente.</span><span class="sxs-lookup"><span data-stu-id="14500-155">When this workflow is invoked, the following output is displayed to the console.</span></span>  
  
 <span data-ttu-id="14500-156">**Avvio della sequenza.**</span><span class="sxs-lookup"><span data-stu-id="14500-156">**Sequence starting.**</span></span>  
<span data-ttu-id="14500-157">**Sequenza annullata.**  </span><span class="sxs-lookup"><span data-stu-id="14500-157">**Sequence canceled.** </span></span>  
<span data-ttu-id="14500-158">**Eccezione rilevata.**  </span><span class="sxs-lookup"><span data-stu-id="14500-158">**Exception caught.** </span></span>  
<span data-ttu-id="14500-159">**E3c18939-121e-4c43-af1c-ba1ce977ce55 del flusso di lavoro completato.**</span><span class="sxs-lookup"><span data-stu-id="14500-159">**Workflow e3c18939-121e-4c43-af1c-ba1ce977ce55 Completed.**</span></span>   
### <a name="throwing-exceptions-from-a-cancellationhandler"></a><span data-ttu-id="14500-160">Generazione di eccezioni da un oggetto CancellationHandler</span><span class="sxs-lookup"><span data-stu-id="14500-160">Throwing Exceptions from a CancellationHandler</span></span>  
 <span data-ttu-id="14500-161">Qualsiasi eccezione generata dalla proprietà <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> di un'attività <xref:System.Activities.Statements.CancellationScope> è irreversibile per il flusso di lavoro.</span><span class="sxs-lookup"><span data-stu-id="14500-161">Any exceptions thrown from the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> of a <xref:System.Activities.Statements.CancellationScope> are fatal to the workflow.</span></span> <span data-ttu-id="14500-162">Se è possibile che le eccezioni escano da una proprietà <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>, usare un oggetto <xref:System.Activities.Statements.TryCatch> nella proprietà <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> per rilevare e gestire tali eccezioni.</span><span class="sxs-lookup"><span data-stu-id="14500-162">If there is a possibility of exceptions escaping from a <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A>, use a <xref:System.Activities.Statements.TryCatch> in the <xref:System.Activities.Statements.CancellationScope.CancellationHandler%2A> to catch and handle these exceptions.</span></span>  
  
### <a name="cancellation-using-compensableactivity"></a><span data-ttu-id="14500-163">Annullamento tramite l'oggetto CompensableActivity</span><span class="sxs-lookup"><span data-stu-id="14500-163">Cancellation using CompensableActivity</span></span>  
 <span data-ttu-id="14500-164">Analogamente all'attività <xref:System.Activities.Statements.CancellationScope>, l'oggetto <xref:System.Activities.Statements.CompensableActivity> dispone di una proprietà <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A>.</span><span class="sxs-lookup"><span data-stu-id="14500-164">Like the <xref:System.Activities.Statements.CancellationScope> activity, the <xref:System.Activities.Statements.CompensableActivity> has a <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A>.</span></span> <span data-ttu-id="14500-165">Se un oggetto <xref:System.Activities.Statements.CompensableActivity> viene annullato, viene richiamata qualsiasi attività nella relativa proprietà <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A>.</span><span class="sxs-lookup"><span data-stu-id="14500-165">If a <xref:System.Activities.Statements.CompensableActivity> is canceled, any activities in its <xref:System.Activities.Statements.CompensableActivity.CancellationHandler%2A> are invoked.</span></span> <span data-ttu-id="14500-166">Tale operazione può essere utile per annullare operazioni compensabili completate parzialmente.</span><span class="sxs-lookup"><span data-stu-id="14500-166">This can be useful for undoing partially completed compensable work.</span></span> <span data-ttu-id="14500-167">Per informazioni su come usare <xref:System.Activities.Statements.CompensableActivity> per la compensazione e l'annullamento, vedere [compensazione](compensation.md).</span><span class="sxs-lookup"><span data-stu-id="14500-167">For information about how to use <xref:System.Activities.Statements.CompensableActivity> for compensation and cancellation, see [Compensation](compensation.md).</span></span>  
  
## <a name="cancellation-using-custom-activities"></a><span data-ttu-id="14500-168">Annullamento tramite attività personalizzate</span><span class="sxs-lookup"><span data-stu-id="14500-168">Cancellation using Custom Activities</span></span>  
 <span data-ttu-id="14500-169">Gli autori di attività personalizzate possono implementare la logica di annullamento nelle proprie attività personalizzate in molti modi diversi.</span><span class="sxs-lookup"><span data-stu-id="14500-169">Custom activity authors can implement cancellation logic into their custom activities in several different ways.</span></span> <span data-ttu-id="14500-170">Le attività personalizzate che derivano da <xref:System.Activities.Activity> possono implementare la logica di annullamento inserendo <xref:System.Activities.Statements.CancellationScope> o un'altra attività personalizzata che contiene la logica di annullamento nel corpo dell'attività.</span><span class="sxs-lookup"><span data-stu-id="14500-170">Custom activities that derive from <xref:System.Activities.Activity> can implement cancellation logic by placing a <xref:System.Activities.Statements.CancellationScope> or other custom activity that contains cancellation logic in the body of the activity.</span></span> <span data-ttu-id="14500-171">Le attività derivate <xref:System.Activities.AsyncCodeActivity> e <xref:System.Activities.NativeActivity> possono eseguire l'override del rispettivo metodo <xref:System.Activities.NativeActivity.Cancel%2A> e fornire qui la logica di annullamento.</span><span class="sxs-lookup"><span data-stu-id="14500-171"><xref:System.Activities.AsyncCodeActivity> and <xref:System.Activities.NativeActivity> derived activities can override their respective <xref:System.Activities.NativeActivity.Cancel%2A> method and provide cancellation logic there.</span></span> <span data-ttu-id="14500-172">Le attività derivate <xref:System.Activities.CodeActivity> non forniscono alcuna misura per l'annullamento poiché tutto il lavoro viene eseguito in un unico picco di esecuzione quando il runtime chiama il metodo <xref:System.Activities.CodeActivity.Execute%2A>.</span><span class="sxs-lookup"><span data-stu-id="14500-172"><xref:System.Activities.CodeActivity> derived activities do not provide any provision for cancellation because all their work is performed in a single burst of execution when the runtime calls the <xref:System.Activities.CodeActivity.Execute%2A> method.</span></span> <span data-ttu-id="14500-173">Se il metodo Execute non è ancora stato chiamato e viene annullata un'attività basata sull'oggetto <xref:System.Activities.CodeActivity>, l'attività viene chiusa con lo stato <xref:System.Activities.ActivityInstanceState.Canceled> e il metodo <xref:System.Activities.CodeActivity.Execute%2A> non viene chiamato.</span><span class="sxs-lookup"><span data-stu-id="14500-173">If the execute method has not yet been called and a <xref:System.Activities.CodeActivity> based activity is canceled, the activity closes with a status of <xref:System.Activities.ActivityInstanceState.Canceled> and the <xref:System.Activities.CodeActivity.Execute%2A> method is not called.</span></span>  
  
### <a name="cancellation-using-nativeactivity"></a><span data-ttu-id="14500-174">Annullamento tramite l'oggetto NativeActivity</span><span class="sxs-lookup"><span data-stu-id="14500-174">Cancellation using NativeActivity</span></span>  
 <span data-ttu-id="14500-175">Le classi derivate <xref:System.Activities.NativeActivity> possono eseguire l'override del metodo <xref:System.Activities.NativeActivity.Cancel%2A> per fornire la logica di annullamento personalizzata.</span><span class="sxs-lookup"><span data-stu-id="14500-175"><xref:System.Activities.NativeActivity> derived activities can override the <xref:System.Activities.NativeActivity.Cancel%2A> method to provide custom cancellation logic.</span></span> <span data-ttu-id="14500-176">Se questo metodo non viene sottoposto a override, viene applicata la logica di annullamento del flusso di lavoro predefinita.</span><span class="sxs-lookup"><span data-stu-id="14500-176">If this method is not overridden, then the default workflow cancellation logic is applied.</span></span> <span data-ttu-id="14500-177">L'annullamento predefinito è il processo che si verifica <xref:System.Activities.NativeActivity> per un oggetto che non <xref:System.Activities.NativeActivity.Cancel%2A> esegue l'override <xref:System.Activities.NativeActivity.Cancel%2A> del metodo o il <xref:System.Activities.NativeActivity> cui metodo chiama il metodo di base <xref:System.Activities.NativeActivity.Cancel%2A> .</span><span class="sxs-lookup"><span data-stu-id="14500-177">Default cancellation is the process that occurs for a <xref:System.Activities.NativeActivity> that does not override the <xref:System.Activities.NativeActivity.Cancel%2A> method or whose <xref:System.Activities.NativeActivity.Cancel%2A> method calls the base <xref:System.Activities.NativeActivity> <xref:System.Activities.NativeActivity.Cancel%2A> method.</span></span> <span data-ttu-id="14500-178">Quando un'attività viene annullata, il runtime contrassegna l'attività per l'annullamento e gestisce automaticamente la pulizia.</span><span class="sxs-lookup"><span data-stu-id="14500-178">When an activity is canceled, the runtime flags the activity for cancellation and automatically handles certain cleanup.</span></span> <span data-ttu-id="14500-179">Se l'attività dispone solo di segnalibri in attesa, questi ultimi saranno rimossi e l'attività sarà contrassegnata come <xref:System.Activities.ActivityInstanceState.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="14500-179">If the activity only has outstanding bookmarks, the bookmarks will be removed and the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="14500-180">Qualsiasi attività figlio in attesa dell'attività annullata sarà annullata a sua volta.</span><span class="sxs-lookup"><span data-stu-id="14500-180">Any outstanding child activities of the canceled activity will in turn be canceled.</span></span> <span data-ttu-id="14500-181">Qualsiasi tentativo di pianificare attività figlio aggiuntive verrà ignorato e l'attività sarà contrassegnata come <xref:System.Activities.ActivityInstanceState.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="14500-181">Any attempt to schedule additional child activities will result in the attempt being ignored and the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="14500-182">Se qualsiasi attività figlio in attesa viene completata nello stato <xref:System.Activities.ActivityInstanceState.Canceled> o <xref:System.Activities.ActivityInstanceState.Faulted>, l'attività sarà contrassegnata come <xref:System.Activities.ActivityInstanceState.Canceled>.</span><span class="sxs-lookup"><span data-stu-id="14500-182">If any outstanding child activity completes in the <xref:System.Activities.ActivityInstanceState.Canceled> or <xref:System.Activities.ActivityInstanceState.Faulted> state, then the activity will be marked as <xref:System.Activities.ActivityInstanceState.Canceled>.</span></span> <span data-ttu-id="14500-183">Si noti che è possibile ignorare una richiesta di annullamento.</span><span class="sxs-lookup"><span data-stu-id="14500-183">Note that a cancellation request can be ignored.</span></span> <span data-ttu-id="14500-184">Se un'attività non dispone di segnalibri in attesa o di attività figlio in esecuzione e non pianifica alcun elemento di lavoro aggiuntivo dopo essere stata contrassegnata per l'annullamento, verrà completata correttamente.</span><span class="sxs-lookup"><span data-stu-id="14500-184">If an activity does not have any outstanding bookmarks or executing child activities and does not schedule any additional work items after being flagged for cancellation, it will complete successfully.</span></span> <span data-ttu-id="14500-185">Questo annullamento predefinito è sufficiente per molti scenari, tuttavia se è necessaria un'ulteriore logica di annullamento, è possibile usare le attività di annullamento incorporate o le attività personalizzate.</span><span class="sxs-lookup"><span data-stu-id="14500-185">This default cancellation suffices for many scenarios, but if additional cancellation logic is needed, then the built-in cancellation activities or custom activities can be used.</span></span>  
  
 <span data-ttu-id="14500-186">Nell'esempio seguente, viene definito l'override <xref:System.Activities.NativeActivity.Cancel%2A> di un'attività <xref:System.Activities.NativeActivity> personalizzata basata sull'oggetto `ParallelForEach`.</span><span class="sxs-lookup"><span data-stu-id="14500-186">In the following example, the <xref:System.Activities.NativeActivity.Cancel%2A> override of a <xref:System.Activities.NativeActivity> based custom `ParallelForEach` activity is defined.</span></span> <span data-ttu-id="14500-187">Quando l'attività viene annullata, questo override gestisce la logica di annullamento per l'attività.</span><span class="sxs-lookup"><span data-stu-id="14500-187">When the activity is canceled, this override handles the cancellation logic for the activity.</span></span> <span data-ttu-id="14500-188">Questo esempio fa parte dell'esempio [ActivityDesigner ParallelForEach non generico](./samples/non-generic-parallelforeach.md) .</span><span class="sxs-lookup"><span data-stu-id="14500-188">This example is part of the [Non-Generic ParallelForEach](./samples/non-generic-parallelforeach.md) sample.</span></span>  
  
```csharp  
protected override void Cancel(NativeActivityContext context)  
{  
    // If we do not have a completion condition then we can just  
    // use default logic.  
    if (this.CompletionCondition == null)  
    {  
        base.Cancel(context);  
    }  
    else  
    {  
        context.CancelChildren();  
    }  
}  
```  
  
 <span data-ttu-id="14500-189">Le attività derivate da <xref:System.Activities.NativeActivity> possono determinare se l'annullamento è stato richiesto in seguito al controllo della proprietà <xref:System.Activities.NativeActivityContext.IsCancellationRequested%2A> e possono contrassegnarsi come annullate chiamando il metodo <xref:System.Activities.NativeActivityContext.MarkCanceled%2A>.</span><span class="sxs-lookup"><span data-stu-id="14500-189"><xref:System.Activities.NativeActivity> derived activities can determine if cancellation has been requested by inspecting the <xref:System.Activities.NativeActivityContext.IsCancellationRequested%2A> property, and mark themselves as canceled by calling the <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> method.</span></span> <span data-ttu-id="14500-190">La chiamata al metodo <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> non completa immediatamente l'attività.</span><span class="sxs-lookup"><span data-stu-id="14500-190">Calling <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> does not immediately complete the activity.</span></span> <span data-ttu-id="14500-191">Come al solito, il runtime completerà l'attività quando non dispone più di alcuna operazione in attesa, tuttavia se viene chiamato il metodo <xref:System.Activities.NativeActivityContext.MarkCanceled%2A>, lo stato finale sarà <xref:System.Activities.ActivityInstanceState.Canceled> anziché <xref:System.Activities.ActivityInstanceState.Closed>.</span><span class="sxs-lookup"><span data-stu-id="14500-191">As usual, the runtime will complete the activity when it has no more outstanding work, but if <xref:System.Activities.NativeActivityContext.MarkCanceled%2A> is called the final state will be <xref:System.Activities.ActivityInstanceState.Canceled> instead of <xref:System.Activities.ActivityInstanceState.Closed>.</span></span>  
  
### <a name="cancellation-using-asynccodeactivity"></a><span data-ttu-id="14500-192">Annullamento tramite l'oggetto AsyncCodeActivity</span><span class="sxs-lookup"><span data-stu-id="14500-192">Cancellation using AsyncCodeActivity</span></span>  
 <span data-ttu-id="14500-193">Anche le attività basate sull'oggetto <xref:System.Activities.AsyncCodeActivity> possono fornire la logica di annullamento personalizzata eseguendo l'override del metodo <xref:System.Activities.AsyncCodeActivity.Cancel%2A>.</span><span class="sxs-lookup"><span data-stu-id="14500-193"><xref:System.Activities.AsyncCodeActivity> based activities can also provide custom cancellation logic by overriding the <xref:System.Activities.AsyncCodeActivity.Cancel%2A> method.</span></span> <span data-ttu-id="14500-194">Se questo metodo non viene sottoposto a override, non viene eseguita alcuna gestione dell'annullamento se l'attività viene annullata.</span><span class="sxs-lookup"><span data-stu-id="14500-194">If this method is not overridden, then no cancellation handling is performed if the activity is canceled.</span></span> <span data-ttu-id="14500-195">Nell'esempio seguente, viene definito l'override <xref:System.Activities.AsyncCodeActivity.Cancel%2A> di un'attività <xref:System.Activities.AsyncCodeActivity> personalizzata basata sull'oggetto `ExecutePowerShell`.</span><span class="sxs-lookup"><span data-stu-id="14500-195">In the following example, the <xref:System.Activities.AsyncCodeActivity.Cancel%2A> override of an <xref:System.Activities.AsyncCodeActivity> based custom `ExecutePowerShell` activity is defined.</span></span> <span data-ttu-id="14500-196">Quando l'attività viene annullata, esegue il comportamento di annullamento desiderato.</span><span class="sxs-lookup"><span data-stu-id="14500-196">When the activity is canceled, it performs the desired cancellation behavior.</span></span>
  
 [!code-csharp[CFX_WorkflowApplicationExample#1020](~/samples/snippets/csharp/VS_Snippets_CFX/cfx_workflowapplicationexample/cs/program.cs#1020)]  
  
 <span data-ttu-id="14500-197">Le attività derivate da <xref:System.Activities.AsyncCodeActivity> possono determinare se l'annullamento è stato richiesto in seguito al controllo della proprietà <xref:System.Activities.AsyncCodeActivityContext.IsCancellationRequested%2A> e possono contrassegnarsi come annullate chiamando il metodo <xref:System.Activities.AsyncCodeActivityContext.MarkCanceled%2A>.</span><span class="sxs-lookup"><span data-stu-id="14500-197"><xref:System.Activities.AsyncCodeActivity> derived activities can determine if cancellation has been requested by inspecting the <xref:System.Activities.AsyncCodeActivityContext.IsCancellationRequested%2A> property, and mark themselves as canceled by calling the <xref:System.Activities.AsyncCodeActivityContext.MarkCanceled%2A> method.</span></span>
