---
title: Implementazione della gestione risorse
ms.date: 03/30/2017
ms.assetid: d5c153f6-4419-49e3-a5f1-a50ae4c81bf3
ms.openlocfilehash: f64a729f49d546dd16c25a2be1f9bd64a2ca8f63
ms.sourcegitcommit: 2d792961ed48f235cf413d6031576373c3050918
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/31/2019
ms.locfileid: "70205955"
---
# <a name="implementing-a-resource-manager"></a><span data-ttu-id="323ff-102">Implementazione della gestione risorse</span><span class="sxs-lookup"><span data-stu-id="323ff-102">Implementing a Resource Manager</span></span>
<span data-ttu-id="323ff-103">Ogni risorsa utilizzata in una transazione viene gestita dalla gestione risorse, le cui azioni vengono coordinate dalla gestione transazioni.</span><span class="sxs-lookup"><span data-stu-id="323ff-103">Each resource used in a transaction is managed by a resource manager, whose actions are coordinated by a transaction manager.</span></span> <span data-ttu-id="323ff-104">I gestori di risorse collaborano con la gestione transazioni allo scopo di garantire atomicità e isolamento all'applicazione.</span><span class="sxs-lookup"><span data-stu-id="323ff-104">Resource managers work in cooperation with the transaction manager to provide the application with a guarantee of atomicity and isolation.</span></span> <span data-ttu-id="323ff-105">Alcuni esempi di gestori di risorse sono le code di messaggi durevoli, le tabelle hash in memoria e Microsoft SQL Server.</span><span class="sxs-lookup"><span data-stu-id="323ff-105">Microsoft SQL Server, durable message queues, in-memory hash tables are all examples of resource managers.</span></span>  
  
 <span data-ttu-id="323ff-106">Un gestore di risorse gestisce dati durevoli o volatili.</span><span class="sxs-lookup"><span data-stu-id="323ff-106">A resource manager manages either durable or volatile data.</span></span> <span data-ttu-id="323ff-107">La durabilità (o la volatilità) di un gestore di risorse ne indica la capacità (o la non capacità) di ripristino in caso di errore.</span><span class="sxs-lookup"><span data-stu-id="323ff-107">The durability (or conversely the volatility) of a resource manager refers to whether the resource manager supports failure recovery.</span></span> <span data-ttu-id="323ff-108">I gestori di risorse che supportano il ripristino in caso di errore salvano i dati in modo permanente in un archivio durevole durante la fase 1, ovvero la fase di preparazione. In questo modo, se il gestore di risorse diventa non disponibile, può reintegrarsi nella transazione non appena viene ripristinato e quindi eseguire le azioni appropriate in base alle notifiche ricevute dalla gestione transazioni.</span><span class="sxs-lookup"><span data-stu-id="323ff-108">If a resource manager supports failure recovery, it persists data to durable storage during Phase1 (prepare) such that if the resource manager goes down, it can re-enlist in the transaction upon recovery and perform the proper actions based on the notifications received from the transaction manager.</span></span> <span data-ttu-id="323ff-109">In generale, i gestori di risorse volatili gestiscono risorse volatili, come nel caso di una struttura di dati in memoria (ad esempio, una tabella hash transazionale in memoria), laddove i gestori di risorse durevoli gestiscono risorse che presentano un archivio di backup permanente, come nel caso di un database con archivio di backup su disco.</span><span class="sxs-lookup"><span data-stu-id="323ff-109">In general, volatile resource managers manage volatile resources such as an in-memory data structure (for example, an in-memory transacted-hashtable), and durable resource managers manage resources that have a more persistent backing store (for example, a database whose backing store is disk).</span></span>  
  
 <span data-ttu-id="323ff-110">Per poter partecipare a una determinata transazione, una risorsa deve integrarsi in essa.</span><span class="sxs-lookup"><span data-stu-id="323ff-110">In order for a resource to participate in a transaction, it must enlist in the transaction.</span></span> <span data-ttu-id="323ff-111">La <xref:System.Transactions.Transaction> classe definisce un set di metodi i cui nomi iniziano con **integrazione** che forniscono questa funzionalità.</span><span class="sxs-lookup"><span data-stu-id="323ff-111">The <xref:System.Transactions.Transaction> class defines a set of methods whose names begin with **Enlist** that provide this functionality.</span></span> <span data-ttu-id="323ff-112">I diversi metodi di integrazione corrispondono ai diversi tipi di integrazione che può avere un gestore di risorse.</span><span class="sxs-lookup"><span data-stu-id="323ff-112">The different **Enlist** methods correspond to the different types of enlistment that a resource manager may have.</span></span> <span data-ttu-id="323ff-113">In particolare, i metodi <xref:System.Transactions.Transaction.EnlistVolatile%2A> vengono utilizzati per le risorse volatili, mentre i metodi <xref:System.Transactions.Transaction.EnlistDurable%2A> vengono utilizzati per le risorse durevoli.</span><span class="sxs-lookup"><span data-stu-id="323ff-113">Specifically, you use the <xref:System.Transactions.Transaction.EnlistVolatile%2A> methods for volatile resources, and the <xref:System.Transactions.Transaction.EnlistDurable%2A> method for durable resources.</span></span> <span data-ttu-id="323ff-114">Per semplicità, dopo aver deciso se utilizzare il metodo <xref:System.Transactions.Transaction.EnlistDurable%2A> o il metodo <xref:System.Transactions.Transaction.EnlistVolatile%2A> a seconda del supporto di durabilità della risorsa utilizzata, è necessario integrare la risorsa nel protocollo 2PC (2-Phase Commit, commit a due fasi) implementando nel gestore di risorse l'interfaccia <xref:System.Transactions.IEnlistmentNotification>.</span><span class="sxs-lookup"><span data-stu-id="323ff-114">For simplicity, after deciding whether to use the <xref:System.Transactions.Transaction.EnlistDurable%2A> or <xref:System.Transactions.Transaction.EnlistVolatile%2A> method based on your resource's durability support, you should enlist your resource to participate in Two Phase Commit (2PC) by implementing the <xref:System.Transactions.IEnlistmentNotification> interface for your resource manager.</span></span> <span data-ttu-id="323ff-115">Per altre informazioni su 2PC, vedere [commit di una transazione in un'unica fase e in più fasi](committing-a-transaction-in-single-phase-and-multi-phase.md).</span><span class="sxs-lookup"><span data-stu-id="323ff-115">For more information on 2PC, see [Committing a Transaction in Single-Phase and Multi-Phase](committing-a-transaction-in-single-phase-and-multi-phase.md).</span></span>  
  
 <span data-ttu-id="323ff-116">L'integrazione in una determinata transazione garantisce al gestore di risorse di ricevere callback dalla gestione transazioni quando la transazione viene interrotta o quando ne viene eseguito il commit.</span><span class="sxs-lookup"><span data-stu-id="323ff-116">By enlisting, the resource manager ensures that it gets callbacks from the transaction manager when the transaction commits or aborts.</span></span> <span data-ttu-id="323ff-117">Per ogni integrazione esiste un'istanza specifica della classe <xref:System.Transactions.IEnlistmentNotification>.</span><span class="sxs-lookup"><span data-stu-id="323ff-117">There is one instance of <xref:System.Transactions.IEnlistmentNotification> per enlistment.</span></span> <span data-ttu-id="323ff-118">In genere esiste un'unica integrazione per ogni transazione. È tuttavia possibile che un gestore di risorse scelga di integrarsi più volte nella stessa transazione.</span><span class="sxs-lookup"><span data-stu-id="323ff-118">Typically, there is one enlistment per transaction, but a resource manager can choose to enlist multiple times in the same transaction.</span></span>  
  
 <span data-ttu-id="323ff-119">Dopo l'integrazione, il gestore di risorse risponde alle richieste della transazione.</span><span class="sxs-lookup"><span data-stu-id="323ff-119">After enlistment, the resource manager responds to the transaction's requests.</span></span> <span data-ttu-id="323ff-120">Un gestore di risorse durevole memorizza una quantità di informazioni sufficiente ad annullare o a ripetere le operazioni della transazione sulle risorse che gestisce.</span><span class="sxs-lookup"><span data-stu-id="323ff-120">A durable resource manager stores enough information to allow it to either undo or redo the transaction's work on resources it manages.</span></span> <span data-ttu-id="323ff-121">Esistono vari metodi per implementare questa funzionalità. Due tecniche comuni sono la memorizzazione di più versioni dei dati o la gestione di un registro delle modifiche.</span><span class="sxs-lookup"><span data-stu-id="323ff-121">There are many ways to do this; keeping versions of data or keeping a log of the changes are two common techniques.</span></span>  
  
 <span data-ttu-id="323ff-122">Quando l'applicazione esegue il commit della transazione, la gestione transazioni avvia il protocollo di commit a due fasi.</span><span class="sxs-lookup"><span data-stu-id="323ff-122">When the application commits the transaction, the transaction manager initiates the two-phase commit protocol.</span></span> <span data-ttu-id="323ff-123">Nella prima fase, la gestione transazioni verifica se ogni gestore di risorse integrato ha eseguito la procedura di preparazione di commit della transazione,</span><span class="sxs-lookup"><span data-stu-id="323ff-123">The transaction manager first asks each enlisted resource manager if it is prepared to commit the transaction.</span></span> <span data-ttu-id="323ff-124">ovvero se è pronto a interrompere la transazione oppure a eseguirne il commit.</span><span class="sxs-lookup"><span data-stu-id="323ff-124">The resource manager must prepare to commit—it readies itself to either commit or abort the transaction.</span></span>  
  
 <span data-ttu-id="323ff-125">Durante questa prima fase di preparazione, il gestore di risorse durevole registra i dati vecchi e nuovi in un archivio permanente. Ciò garantisce la possibilità di recuperare i dati anche in caso di errore di sistema.</span><span class="sxs-lookup"><span data-stu-id="323ff-125">During the prepare phase, the durable resource manager records the old and new data in stable storage so that the resource manager can recover it even if the system fails.</span></span> <span data-ttu-id="323ff-126">Se il gestore di risorse è in grado di completare la procedura di preparazione, comunica alla gestione transazioni il proprio voto a favore del commit o dell'interruzione della transazione.</span><span class="sxs-lookup"><span data-stu-id="323ff-126">If the resource manager can prepare, it informs the transaction manager its vote on whether to commit or abort the transaction.</span></span> <span data-ttu-id="323ff-127">Se uno dei gestori di risorse segnala un errore durante la fase di preparazione, la gestione transazioni invia un comando di rollback a ogni gestore di risorse e informa l'applicazione in merito all'esito negativo del commit.</span><span class="sxs-lookup"><span data-stu-id="323ff-127">If any resource manager reports a failure to prepare, the transaction manager sends a rollback command to each resource manager and indicates the failure of the commit to the application.</span></span>  
  
 <span data-ttu-id="323ff-128">Dopo la preparazione, un gestore di risorse deve attendere per ottenere un commit o un callback di interruzione dalla gestione transazioni nella fase 2.</span><span class="sxs-lookup"><span data-stu-id="323ff-128">Once prepared, a resource manager must wait until it gets a commit or abort callback from the transaction manager in phase 2.</span></span> <span data-ttu-id="323ff-129">Il completamento della preparazione e il protocollo di commit generalmente richiedono una frazione di secondo.</span><span class="sxs-lookup"><span data-stu-id="323ff-129">Typically, the entire prepare and commit protocol completes in a fraction of a second.</span></span> <span data-ttu-id="323ff-130">Tuttavia, se si verificano errori di sistema o di comunicazione, la notifica di commit o di interruzione può richiedere minuti o persino ore.</span><span class="sxs-lookup"><span data-stu-id="323ff-130">If there are system or communication failures, the commit or abort notification may not arrive for minutes or hours.</span></span> <span data-ttu-id="323ff-131">Durante questo periodo, il gestore di risorse è incerto sul risultato della transazione</span><span class="sxs-lookup"><span data-stu-id="323ff-131">During this period, the resource manager is in doubt about the outcome of the transaction.</span></span> <span data-ttu-id="323ff-132">e non è in grado di stabilire se procedere al commit o all'interruzione della transazione.</span><span class="sxs-lookup"><span data-stu-id="323ff-132">It does not know whether the transaction committed or aborted.</span></span> <span data-ttu-id="323ff-133">Per proteggere i dati modificati e impedirne la modifica da parte di altre transazioni, il gestore di risorse blocca la transazione finché non riceve una notifica definitiva.</span><span class="sxs-lookup"><span data-stu-id="323ff-133">While the resource manager is in doubt about a transaction, it keeps the data modified by keeping the transaction locked, thereby isolating these changes from any other transactions.</span></span>  
  
 <span data-ttu-id="323ff-134">Quando si verifica un errore in un gestore di risorse, tutte le transazioni a cui quest'ultimo è integrato vengono interrotte, ad eccezione di quelle per cui la procedura di preparazione o di commit è stata eseguita prima dell'errore.</span><span class="sxs-lookup"><span data-stu-id="323ff-134">When a resource manager fails, all of its enlisted transactions are aborted except for those that are prepared or committed prior to the failure.</span></span> <span data-ttu-id="323ff-135">Quando viene riavviato, un gestore di risorse durevole ricostruisce lo stato di commit delle risorse gestite. A tale scopo, recupera le informazioni di preparazione scritte nella fase 1 e quindi procede di conseguenza al commit o all'interruzione delle transazioni precedentemente interrotte.</span><span class="sxs-lookup"><span data-stu-id="323ff-135">When a durable resource manager restarts, it reconstructs the committed state of the resources it manages by retrieving the prepare information written in the prepare phase, and commits or aborts these transactions accordingly.</span></span>  
  
 <span data-ttu-id="323ff-136">In breve, il protocollo di commit a due fasi e i gestori di risorse collaborano per garantire l'atomicità e la durevolezza delle transazioni.</span><span class="sxs-lookup"><span data-stu-id="323ff-136">In summary, the two-phase commit protocol and the resource managers combine to make transactions atomic and durable.</span></span>  
  
 <span data-ttu-id="323ff-137">La classe <xref:System.Transactions.Transaction> fornisce inoltre il metodo <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> per eseguire l'integrazione PSPE (Promotable Single Phase Enlistment).</span><span class="sxs-lookup"><span data-stu-id="323ff-137">The <xref:System.Transactions.Transaction> class also provides the <xref:System.Transactions.Transaction.EnlistPromotableSinglePhase%2A> method to enlist a Promotable Single Phase Enlistment (PSPE).</span></span> <span data-ttu-id="323ff-138">Grazie a questo meccanismo, un gestore di risorse durevoli può ospitare e "possedere" una transazione di cui in seguito può eseguire l'escalation in modo che venga gestita dal gestore MSDTC, se necessario.</span><span class="sxs-lookup"><span data-stu-id="323ff-138">This allows a durable resource manager (RM) to host and "own" a transaction that can later be escalated to be managed by the MSDTC if necessary.</span></span> <span data-ttu-id="323ff-139">Per altre informazioni, vedere [ottimizzazione tramite commit a fase singola e notifica a singola fase](optimization-spc-and-promotable-spn.md)promuovibile.</span><span class="sxs-lookup"><span data-stu-id="323ff-139">For more information on this, see [Optimization using Single Phase Commit and Promotable Single Phase Notification](optimization-spc-and-promotable-spn.md).</span></span>  
  
## <a name="in-this-section"></a><span data-ttu-id="323ff-140">In questa sezione</span><span class="sxs-lookup"><span data-stu-id="323ff-140">In This Section</span></span>  
 <span data-ttu-id="323ff-141">I passaggi che in genere vengono eseguiti dai gestori di risorse sono descritti negli argomenti seguenti.</span><span class="sxs-lookup"><span data-stu-id="323ff-141">The steps generally followed by a resource manager are outlined in the following topics.</span></span>  
  
 [<span data-ttu-id="323ff-142">Integrazione di risorse come partecipanti a una transazione</span><span class="sxs-lookup"><span data-stu-id="323ff-142">Enlisting Resources as Participants in a Transaction</span></span>](enlisting-resources-as-participants-in-a-transaction.md)  
  
 <span data-ttu-id="323ff-143">Descrive come una risorsa durevole o volatile può integrarsi in una transazione.</span><span class="sxs-lookup"><span data-stu-id="323ff-143">Describes how a durable or volatile resource can enlist in a transaction.</span></span>  
  
 [<span data-ttu-id="323ff-144">Commit di una transazione in monofase e multifase</span><span class="sxs-lookup"><span data-stu-id="323ff-144">Committing a Transaction in Single-Phase and Multi-Phase</span></span>](committing-a-transaction-in-single-phase-and-multi-phase.md)  
  
 <span data-ttu-id="323ff-145">Descrive come un gestore di risorse risponde a una notifica di commit ed esegue la procedura di preparazione.</span><span class="sxs-lookup"><span data-stu-id="323ff-145">Describes how a resource manager responds to commit notification and prepare the commit.</span></span>  
  
 [<span data-ttu-id="323ff-146">Esecuzione del ripristino</span><span class="sxs-lookup"><span data-stu-id="323ff-146">Performing Recovery</span></span>](performing-recovery.md)  
  
 <span data-ttu-id="323ff-147">Descrive la procedura di ripristino eseguita da un gestore di risorse in caso di errore.</span><span class="sxs-lookup"><span data-stu-id="323ff-147">Describes how a durable resource manager recovers from failure.</span></span>  
  
 [<span data-ttu-id="323ff-148">Restrizioni di accesso alle risorse in base ai livelli di attendibilità di sicurezza</span><span class="sxs-lookup"><span data-stu-id="323ff-148">Security Trust Levels in Accessing Resources</span></span>](security-trust-levels-in-accessing-resources.md)  
  
 <span data-ttu-id="323ff-149">Descrive come i tre livelli di attendibilità di System.Transactions limitano l'accesso ai tipi di risorse esposte dallo spazio dei nomi <xref:System.Transactions>.</span><span class="sxs-lookup"><span data-stu-id="323ff-149">Describes how the three levels of trust for System.Transactions restrict access on the types of resources that <xref:System.Transactions> exposes.</span></span>  
  
 [<span data-ttu-id="323ff-150">Ottimizzazione mediante commit monofase e notifica monofase promuovibile</span><span class="sxs-lookup"><span data-stu-id="323ff-150">Optimization using Single Phase Commit and Promotable Single Phase Notification</span></span>](optimization-spc-and-promotable-spn.md)  
  
 <span data-ttu-id="323ff-151">Descrive alcune metodologie di ottimizzazione delle implementazioni dei gestori di risorse.</span><span class="sxs-lookup"><span data-stu-id="323ff-151">Describes optimization practices available to implementations of resource managers.</span></span>
