---
title: Implementazione di una transazione implicita utilizzando l'ambito di transazione
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 49d1706a-1e0c-4c85-9704-75c908372eb9
ms.openlocfilehash: e3af361f4268e9a83efe4d28547dc95fc242633e
ms.sourcegitcommit: ad800f019ac976cb669e635fb0ea49db740e6890
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 10/29/2019
ms.locfileid: "73040206"
---
# <a name="implementing-an-implicit-transaction-using-transaction-scope"></a><span data-ttu-id="2b551-102">Implementazione di una transazione implicita utilizzando l'ambito di transazione</span><span class="sxs-lookup"><span data-stu-id="2b551-102">Implementing an Implicit Transaction using Transaction Scope</span></span>
<span data-ttu-id="2b551-103">La classe <xref:System.Transactions.TransactionScope> consente di contrassegnare facilmente un blocco di codice come ambito partecipante a una transazione, senza che sia necessario interagire con la transazione stessa.</span><span class="sxs-lookup"><span data-stu-id="2b551-103">The <xref:System.Transactions.TransactionScope> class provides a simple way to mark a block of code as participating in a transaction, without requiring you to interact with the transaction itself.</span></span> <span data-ttu-id="2b551-104">Un ambito di transazione può selezionare e gestire automaticamente la transazione di ambiente.</span><span class="sxs-lookup"><span data-stu-id="2b551-104">A transaction scope can select and manage the ambient transaction automatically.</span></span> <span data-ttu-id="2b551-105">In quanto efficiente e di facile utilizzo, la classe <xref:System.Transactions.TransactionScope> rappresenta la scelta ideale per sviluppare un'applicazione transazionale.</span><span class="sxs-lookup"><span data-stu-id="2b551-105">Due to its ease of use and efficiency, it is recommended that you use the <xref:System.Transactions.TransactionScope> class when developing a transaction application.</span></span>  
  
 <span data-ttu-id="2b551-106">Tale classe consente inoltre di eliminare la necessità di integrare esplicitamente le risorse nella transazione.</span><span class="sxs-lookup"><span data-stu-id="2b551-106">In addition, you do not need to enlist resources explicitly with the transaction.</span></span> <span data-ttu-id="2b551-107">Qualsiasi gestore di risorse dello spazio dei nomi <xref:System.Transactions> (ad esempio SQL Server 2005) è in grado di rilevare l'esistenza di una transazione di ambiente creata dall'ambito e quindi integrarsi automaticamente in tale transazione.</span><span class="sxs-lookup"><span data-stu-id="2b551-107">Any <xref:System.Transactions> resource manager (such as SQL Server 2005) can detect the existence of an ambient transaction created by the scope and automatically enlist.</span></span>  
  
## <a name="creating-a-transaction-scope"></a><span data-ttu-id="2b551-108">Creazione di un ambito di transazione</span><span class="sxs-lookup"><span data-stu-id="2b551-108">Creating a transaction scope</span></span>  
 <span data-ttu-id="2b551-109">Nell'esempio seguente viene illustrato un utilizzo semplificato della classe <xref:System.Transactions.TransactionScope>.</span><span class="sxs-lookup"><span data-stu-id="2b551-109">The following sample shows a simple usage of the <xref:System.Transactions.TransactionScope> class.</span></span>  
  
 [!code-csharp[TransactionScope#1](../../../../samples/snippets/csharp/VS_Snippets_Remoting/TransactionScope/cs/ScopeWithSQL.cs#1)]
 [!code-vb[TransactionScope#1](../../../../samples/snippets/visualbasic/VS_Snippets_Remoting/TransactionScope/vb/ScopeWithSQL.vb#1)]  
  
 <span data-ttu-id="2b551-110">L'ambito di transazione viene avviato non appena si crea un nuovo oggetto <xref:System.Transactions.TransactionScope>.</span><span class="sxs-lookup"><span data-stu-id="2b551-110">The transaction scope is started once you create a new <xref:System.Transactions.TransactionScope> object.</span></span>  <span data-ttu-id="2b551-111">Come illustrato nell'esempio di codice, è consigliabile creare gli ambiti con un'istruzione `using`.</span><span class="sxs-lookup"><span data-stu-id="2b551-111">As illustrated in the code sample, it is recommended that you create scopes with a `using` statement.</span></span> <span data-ttu-id="2b551-112">L'istruzione `using` è disponibile sia in C# che in Visual Basic e funziona come un blocco di`finally``try`... per garantire che l'ambito venga eliminato correttamente.</span><span class="sxs-lookup"><span data-stu-id="2b551-112">The `using` statement is available both in C# and in Visual Basic, and works like a `try`...`finally` block to ensure that the scope is disposed of properly.</span></span>  
  
 <span data-ttu-id="2b551-113">Quando si crea un'istanza di <xref:System.Transactions.TransactionScope>, la gestione transazioni determina la transazione a cui partecipare.</span><span class="sxs-lookup"><span data-stu-id="2b551-113">When you instantiate <xref:System.Transactions.TransactionScope>, the transaction manager determines which transaction to participate in.</span></span> <span data-ttu-id="2b551-114">Una volta deciso, l'ambito partecipa sempre a quella transazione.</span><span class="sxs-lookup"><span data-stu-id="2b551-114">Once determined, the scope always participates in that transaction.</span></span> <span data-ttu-id="2b551-115">La decisione si basa su due fattori: la presenza di una transazione di ambiente e il valore del parametro `TransactionScopeOption` del costruttore.</span><span class="sxs-lookup"><span data-stu-id="2b551-115">The decision is based on two factors: whether an ambient transaction is present and the value of the `TransactionScopeOption` parameter in the constructor.</span></span> <span data-ttu-id="2b551-116">La transazione di ambiente è la transazione in cui il codice viene eseguito.</span><span class="sxs-lookup"><span data-stu-id="2b551-116">The ambient transaction is the transaction within which your code executes.</span></span> <span data-ttu-id="2b551-117">Per ottenere un riferimento a questa transazione è possibile chiamare la proprietà <xref:System.Transactions.Transaction.Current%2A?displayProperty=nameWithType> statica della classe <xref:System.Transactions.Transaction>.</span><span class="sxs-lookup"><span data-stu-id="2b551-117">You can obtain a reference to the ambient transaction by calling the static <xref:System.Transactions.Transaction.Current%2A?displayProperty=nameWithType> property of the <xref:System.Transactions.Transaction> class.</span></span> <span data-ttu-id="2b551-118">Per ulteriori informazioni sull'utilizzo di questo parametro, vedere la sezione [gestione del flusso delle transazioni con TransactionScopeOption](#ManageTxFlow) di questo argomento.</span><span class="sxs-lookup"><span data-stu-id="2b551-118">For more information on how this parameter is used, see the [Managing transaction flow using TransactionScopeOption](#ManageTxFlow) section of this topic.</span></span>  
  
## <a name="completing-a-transaction-scope"></a><span data-ttu-id="2b551-119">Completamento di un ambito di transazione</span><span class="sxs-lookup"><span data-stu-id="2b551-119">Completing a transaction scope</span></span>  
 <span data-ttu-id="2b551-120">Quando in una determinata applicazione vengono completate tutte le operazioni che si desidera eseguire in una transazione, è necessario chiamare una sola volta il metodo <xref:System.Transactions.TransactionScope.Complete%2A?displayProperty=nameWIthType> per informare la gestione transazioni che può essere eseguito il commit della transazione.</span><span class="sxs-lookup"><span data-stu-id="2b551-120">When your application completes all the work it wants to perform in a transaction, you should call the <xref:System.Transactions.TransactionScope.Complete%2A?displayProperty=nameWIthType> method only once to inform the transaction manager that it is acceptable to commit the transaction.</span></span> <span data-ttu-id="2b551-121">È consigliabile inserire la chiamata al metodo <xref:System.Transactions.TransactionScope.Complete%2A> come ultima istruzione del blocco `using`.</span><span class="sxs-lookup"><span data-stu-id="2b551-121">It is very good practice to put the call to <xref:System.Transactions.TransactionScope.Complete%2A> as the last statement in the `using` block.</span></span>  
  
 <span data-ttu-id="2b551-122">La mancata chiamata di questo metodo interrompe la transazione, perché la gestione transazioni lo interpreta come un errore di sistema o equivale a un'eccezione generata nell'ambito della transazione.</span><span class="sxs-lookup"><span data-stu-id="2b551-122">Failing to call this method aborts the transaction, because the transaction manager interprets this as a system failure, or equivalent to an exception thrown within the scope of the transaction.</span></span> <span data-ttu-id="2b551-123">Tuttavia, chiamare questo metodo non garantisce l'esecuzione del commit della transazione.</span><span class="sxs-lookup"><span data-stu-id="2b551-123">However, calling this method does not guarantee that the transaction wil be committed.</span></span> <span data-ttu-id="2b551-124">Si tratta semplicemente di un modo per passare alla gestione transazioni le informazioni sullo stato.</span><span class="sxs-lookup"><span data-stu-id="2b551-124">It is merely a way of informing the transaction manager of your status.</span></span> <span data-ttu-id="2b551-125">Dopo aver chiamato il metodo <xref:System.Transactions.TransactionScope.Complete%2A> non è più consentito utilizzare la proprietà <xref:System.Transactions.Transaction.Current%2A> per accedere alla transazione di ambiente. Se si ignora tale restrizione, il sistema genera un'eccezione.</span><span class="sxs-lookup"><span data-stu-id="2b551-125">After calling the <xref:System.Transactions.TransactionScope.Complete%2A> method, you can no longer access the ambient transaction by using the <xref:System.Transactions.Transaction.Current%2A> property, and attempting to do so will result in an exception being thrown.</span></span>  
  
 <span data-ttu-id="2b551-126">Se la transazione è stata creata inizialmente dall'oggetto <xref:System.Transactions.TransactionScope>, la gestione transazioni esegue effettivamente il commit della transazione solo all'ultima riga di codice del blocco `using`.</span><span class="sxs-lookup"><span data-stu-id="2b551-126">If the <xref:System.Transactions.TransactionScope> object created the transaction initially, the actual work of committing the transaction by the transaction manager occurs after the last line of code in the `using` block.</span></span> <span data-ttu-id="2b551-127">In caso contrario, il commit viene eseguito ogni volta che il metodo <xref:System.Transactions.CommittableTransaction.Commit%2A> viene chiamato dal proprietario dell'oggetto <xref:System.Transactions.CommittableTransaction>.</span><span class="sxs-lookup"><span data-stu-id="2b551-127">If it did not create the transaction, the commit occurs whenever <xref:System.Transactions.CommittableTransaction.Commit%2A> is called by the owner of the <xref:System.Transactions.CommittableTransaction> object.</span></span> <span data-ttu-id="2b551-128">A questo punto, il gestore delle transazioni chiama i gestori delle risorse e li informa di eseguire il commit o il rollback, a seconda che il metodo <xref:System.Transactions.TransactionScope.Complete%2A> sia stato chiamato sull'oggetto <xref:System.Transactions.TransactionScope>.</span><span class="sxs-lookup"><span data-stu-id="2b551-128">At that point the transaction manager calls the resource managers and informs them to either commit or rollback, based on whether the <xref:System.Transactions.TransactionScope.Complete%2A> method was called on the <xref:System.Transactions.TransactionScope> object.</span></span>  
  
 <span data-ttu-id="2b551-129">L'istruzione `using` garantisce che il metodo <xref:System.Transactions.TransactionScope.Dispose%2A> dell'oggetto <xref:System.Transactions.TransactionScope> venga chiamato anche se si verifica un'eccezione.</span><span class="sxs-lookup"><span data-stu-id="2b551-129">The `using` statement ensures that the <xref:System.Transactions.TransactionScope.Dispose%2A> method of the <xref:System.Transactions.TransactionScope> object is called even if an exception occurs.</span></span> <span data-ttu-id="2b551-130">Il metodo <xref:System.Transactions.TransactionScope.Dispose%2A> indica la fine dell'ambito della transazione.</span><span class="sxs-lookup"><span data-stu-id="2b551-130">The <xref:System.Transactions.TransactionScope.Dispose%2A> method marks the end of the transaction scope.</span></span> <span data-ttu-id="2b551-131">Le eccezioni che si verificano dopo la chiamata a questo metodo potrebbero non avere alcun effetto sulla transazione.</span><span class="sxs-lookup"><span data-stu-id="2b551-131">Exceptions that occur after calling this method may not affect the transaction.</span></span> <span data-ttu-id="2b551-132">Questo metodo consente inoltre di ripristinare lo stato precedente della transazione di ambiente.</span><span class="sxs-lookup"><span data-stu-id="2b551-132">This method also restores the ambient transaction to it previous state.</span></span>  
  
 <span data-ttu-id="2b551-133">Se l'ambito crea la transazione e quest'ultima viene interrotta, viene generata un'eccezione <xref:System.Transactions.TransactionAbortedException>.</span><span class="sxs-lookup"><span data-stu-id="2b551-133">A <xref:System.Transactions.TransactionAbortedException> is thrown if the scope creates the transaction, and the transaction is aborted.</span></span> <span data-ttu-id="2b551-134">Se la gestione transazioni non è in grado di prendere una decisione in merito al commit, viene generata un'eccezione <xref:System.Transactions.TransactionInDoubtException>.</span><span class="sxs-lookup"><span data-stu-id="2b551-134">A <xref:System.Transactions.TransactionInDoubtException> is thrown if the transaction manager cannot reach a Commit decision.</span></span> <span data-ttu-id="2b551-135">Se viene eseguito il commit della transazione, non viene generata alcuna eccezione.</span><span class="sxs-lookup"><span data-stu-id="2b551-135">No exception is thrown if the transaction is committed.</span></span>  
  
## <a name="rolling-back-a-transaction"></a><span data-ttu-id="2b551-136">Esecuzione del rollback di una transazione</span><span class="sxs-lookup"><span data-stu-id="2b551-136">Rolling back a transaction</span></span>  
 <span data-ttu-id="2b551-137">Non è consigliabile chiamare il metodo <xref:System.Transactions.TransactionScope.Complete%2A> all'interno dell'ambito di una determinata transazione allo scopo di eseguirne il rollback.</span><span class="sxs-lookup"><span data-stu-id="2b551-137">If you want to rollback a transaction, you should not call the <xref:System.Transactions.TransactionScope.Complete%2A> method within the transaction scope.</span></span> <span data-ttu-id="2b551-138">Ad esempio, è preferibile generare un'eccezione all'interno dell'ambito.</span><span class="sxs-lookup"><span data-stu-id="2b551-138">For example, you can throw an exception within the scope.</span></span> <span data-ttu-id="2b551-139">In tal caso, verrà eseguito il rollback della transazione a cui tale ambito partecipa.</span><span class="sxs-lookup"><span data-stu-id="2b551-139">The transaction in which it participates in will be rolled back.</span></span>  
  
## <a name="ManageTxFlow"></a><span data-ttu-id="2b551-140">Gestione del flusso delle transazioni con TransactionScopeOption</span><span class="sxs-lookup"><span data-stu-id="2b551-140">Managing transaction flow using TransactionScopeOption</span></span>  
 <span data-ttu-id="2b551-141">Gli ambiti di transazione possono essere annidati chiamando un metodo che utilizza un oggetto <xref:System.Transactions.TransactionScope> dall'interno di un metodo dotato di un proprio ambito, come nel caso del metodo `RootMethod` illustrato nell'esempio seguente</span><span class="sxs-lookup"><span data-stu-id="2b551-141">Transaction scope can be nested by calling a method that uses a <xref:System.Transactions.TransactionScope> from within a method that uses its own scope, as is the case with the `RootMethod` method in the following example,</span></span>  
  
```csharp  
void RootMethod()
{
    using(TransactionScope scope = new TransactionScope())
    {
        /* Perform transactional work here */
        SomeMethod();
        scope.Complete();
    }
}

void SomeMethod()
{
    using(TransactionScope scope = new TransactionScope())
    {
        /* Perform transactional work here */
        scope.Complete();
    }
}
```  
  
 <span data-ttu-id="2b551-142">L'ambito di transazione superiore viene detto ambito radice.</span><span class="sxs-lookup"><span data-stu-id="2b551-142">The top-most transaction scope is referred to as the root scope.</span></span>  
  
 <span data-ttu-id="2b551-143">La classe <xref:System.Transactions.TransactionScope> fornisce diversi overload di costruttori che accettano un'enumerazione di tipo <xref:System.Transactions.TransactionScopeOption> che definisce il comportamento transazionale dell'ambito.</span><span class="sxs-lookup"><span data-stu-id="2b551-143">The <xref:System.Transactions.TransactionScope> class provides several overloaded constructors that accept an enumeration of the type <xref:System.Transactions.TransactionScopeOption>, which defines the transactional behavior of the scope.</span></span>  
  
 <span data-ttu-id="2b551-144">Per gli oggetti <xref:System.Transactions.TransactionScope> sono disponibili tre opzioni:</span><span class="sxs-lookup"><span data-stu-id="2b551-144">A <xref:System.Transactions.TransactionScope> object has three options:</span></span>  
  
- <span data-ttu-id="2b551-145">Aggiungersi alla transazione di ambiente, se presente, oppure crearne una nuova.</span><span class="sxs-lookup"><span data-stu-id="2b551-145">Join the ambient transaction, or create a new one if one does not exist.</span></span>  
  
- <span data-ttu-id="2b551-146">Essere un nuovo ambito radice, ovvero avviare una nuova transazione e definire tale transazione come una nuova transazione di ambiente contenuta all'interno del proprio ambito.</span><span class="sxs-lookup"><span data-stu-id="2b551-146">Be a new root scope, that is, start a new transaction and have that transaction be the new ambient transaction inside its own scope.</span></span>  
  
- <span data-ttu-id="2b551-147">Non partecipare ad alcuna transazione.</span><span class="sxs-lookup"><span data-stu-id="2b551-147">Not take part in a transaction at all.</span></span> <span data-ttu-id="2b551-148">In questo caso non viene creata alcuna transazione di ambiente.</span><span class="sxs-lookup"><span data-stu-id="2b551-148">There is no ambient transaction as a result.</span></span>  
  
 <span data-ttu-id="2b551-149">Se l'ambito viene istanziato con l'opzione <xref:System.Transactions.TransactionScopeOption.Required> ed è presente una transazione di ambiente, l'ambito si aggiunge a tale transazione.</span><span class="sxs-lookup"><span data-stu-id="2b551-149">If the scope is instantiated with <xref:System.Transactions.TransactionScopeOption.Required>, and an ambient transaction is present, the scope joins that transaction.</span></span> <span data-ttu-id="2b551-150">Se invece non è presente alcuna transazione di ambiente, l'ambito crea una nuova transazione e diventa l'ambito radice.</span><span class="sxs-lookup"><span data-stu-id="2b551-150">If, on the other hand, there is no ambient transaction, then the scope creates a new transaction, and become the root scope.</span></span> <span data-ttu-id="2b551-151">Questo è il valore predefinito.</span><span class="sxs-lookup"><span data-stu-id="2b551-151">This is the default value.</span></span> <span data-ttu-id="2b551-152">Quando si utilizza l'opzione <xref:System.Transactions.TransactionScopeOption.Required>, l'ambito deve presentare lo stesso comportamento sia che rappresenti l'ambito radice</span><span class="sxs-lookup"><span data-stu-id="2b551-152">When <xref:System.Transactions.TransactionScopeOption.Required> is used, the code inside the scope does not need to behave differently whether it is the root or just joining the ambient transaction.</span></span> <span data-ttu-id="2b551-153">sia che si aggiunga alla transazione di ambiente esistente.</span><span class="sxs-lookup"><span data-stu-id="2b551-153">It should operate identically in both cases.</span></span>  
  
 <span data-ttu-id="2b551-154">Se l'ambito viene istanziato con l'opzione <xref:System.Transactions.TransactionScopeOption.RequiresNew>, tale ambito rappresenta sempre l'ambito radice.</span><span class="sxs-lookup"><span data-stu-id="2b551-154">If the scope is instantiated with <xref:System.Transactions.TransactionScopeOption.RequiresNew>, it is always the root scope.</span></span> <span data-ttu-id="2b551-155">A tale scopo, avvia una nuova transazione che definisce come una nuova transazione di ambiente all'interno del proprio ambito.</span><span class="sxs-lookup"><span data-stu-id="2b551-155">It starts a new transaction, and its transaction becomes the new ambient transaction inside the scope.</span></span>  
  
 <span data-ttu-id="2b551-156">Se l'ambito viene istanziato con l'opzione <xref:System.Transactions.TransactionScopeOption.Suppress>, tale ambito non partecipa ad alcuna transazione, indipendentemente dalla presenza di una transazione di ambito.</span><span class="sxs-lookup"><span data-stu-id="2b551-156">If the scope is instantiated with <xref:System.Transactions.TransactionScopeOption.Suppress>, it never takes part in a transaction, regardless of whether an ambient transaction is present.</span></span> <span data-ttu-id="2b551-157">Gli ambiti istanziati con questo valore presentano sempre una transazione di ambiente `null`.</span><span class="sxs-lookup"><span data-stu-id="2b551-157">A scope instantiated with this value always have `null` as its ambient transaction.</span></span>  
  
 <span data-ttu-id="2b551-158">La tabella seguente contiene un riepilogo delle opzioni appena elencate.</span><span class="sxs-lookup"><span data-stu-id="2b551-158">The above options are summarized in the following table.</span></span>  
  
|<span data-ttu-id="2b551-159">TransactionScopeOption</span><span class="sxs-lookup"><span data-stu-id="2b551-159">TransactionScopeOption</span></span>|<span data-ttu-id="2b551-160">Transazione di ambiente</span><span class="sxs-lookup"><span data-stu-id="2b551-160">Ambient Transaction</span></span>|<span data-ttu-id="2b551-161">Transazione a cui partecipa l'ambito</span><span class="sxs-lookup"><span data-stu-id="2b551-161">The scope takes part in</span></span>|  
|----------------------------|-------------------------|-----------------------------|  
|<span data-ttu-id="2b551-162">Richiesto</span><span class="sxs-lookup"><span data-stu-id="2b551-162">Required</span></span>|<span data-ttu-id="2b551-163">No</span><span class="sxs-lookup"><span data-stu-id="2b551-163">No</span></span>|<span data-ttu-id="2b551-164">Nuova transazione (sarà la radice)</span><span class="sxs-lookup"><span data-stu-id="2b551-164">New Transaction (will be the root)</span></span>|  
|<span data-ttu-id="2b551-165">RequiresNew</span><span class="sxs-lookup"><span data-stu-id="2b551-165">Requires New</span></span>|<span data-ttu-id="2b551-166">No</span><span class="sxs-lookup"><span data-stu-id="2b551-166">No</span></span>|<span data-ttu-id="2b551-167">Nuova transazione (sarà la radice)</span><span class="sxs-lookup"><span data-stu-id="2b551-167">New Transaction (will be the root)</span></span>|  
|<span data-ttu-id="2b551-168">Suppress</span><span class="sxs-lookup"><span data-stu-id="2b551-168">Suppress</span></span>|<span data-ttu-id="2b551-169">No</span><span class="sxs-lookup"><span data-stu-id="2b551-169">No</span></span>|<span data-ttu-id="2b551-170">Nessuna transazione</span><span class="sxs-lookup"><span data-stu-id="2b551-170">No Transaction</span></span>|  
|<span data-ttu-id="2b551-171">Richiesto</span><span class="sxs-lookup"><span data-stu-id="2b551-171">Required</span></span>|<span data-ttu-id="2b551-172">Yes</span><span class="sxs-lookup"><span data-stu-id="2b551-172">Yes</span></span>|<span data-ttu-id="2b551-173">Transazione di ambiente</span><span class="sxs-lookup"><span data-stu-id="2b551-173">Ambient  Transaction</span></span>|  
|<span data-ttu-id="2b551-174">RequiresNew</span><span class="sxs-lookup"><span data-stu-id="2b551-174">Requires New</span></span>|<span data-ttu-id="2b551-175">Yes</span><span class="sxs-lookup"><span data-stu-id="2b551-175">Yes</span></span>|<span data-ttu-id="2b551-176">Nuova transazione (sarà la radice)</span><span class="sxs-lookup"><span data-stu-id="2b551-176">New Transaction (will be the root)</span></span>|  
|<span data-ttu-id="2b551-177">Suppress</span><span class="sxs-lookup"><span data-stu-id="2b551-177">Suppress</span></span>|<span data-ttu-id="2b551-178">Yes</span><span class="sxs-lookup"><span data-stu-id="2b551-178">Yes</span></span>|<span data-ttu-id="2b551-179">Nessuna transazione</span><span class="sxs-lookup"><span data-stu-id="2b551-179">No Transaction</span></span>|  
  
 <span data-ttu-id="2b551-180">Quando un oggetto <xref:System.Transactions.TransactionScope> si aggiunge a una transazione di ambiente esistente, è possibile che l'eliminazione dell'ambito non comporti il termine della transazione, a meno che quest'ultima non venga interrotta dall'ambito.</span><span class="sxs-lookup"><span data-stu-id="2b551-180">When a <xref:System.Transactions.TransactionScope> object joins an existing ambient transaction, disposing of the scope object may not end the transaction, unless the scope aborts the transaction.</span></span> <span data-ttu-id="2b551-181">Se la transazione di ambiente è stata creata da un ambito radice, il metodo <xref:System.Transactions.CommittableTransaction.Commit%2A> viene chiamato sulla transazione solo quando l'ambito radice viene eliminato.</span><span class="sxs-lookup"><span data-stu-id="2b551-181">If the ambient transaction was created by a root scope, only when the root scope is disposed of, does <xref:System.Transactions.CommittableTransaction.Commit%2A> get called on the transaction.</span></span> <span data-ttu-id="2b551-182">Se la transazione è stata creata manualmente, la transazione termina quando il suo creatore la interrompe o ne esegue il commit.</span><span class="sxs-lookup"><span data-stu-id="2b551-182">If the transaction was created manually, the transaction ends when it is either aborted, or committed by its creator.</span></span>  
  
 <span data-ttu-id="2b551-183">Nell'esempio seguente viene mostrato un oggetto <xref:System.Transactions.TransactionScope> che crea tre oggetti ambito annidati, ognuno istanziato con un valore distinto dell'enumerazione <xref:System.Transactions.TransactionScopeOption>.</span><span class="sxs-lookup"><span data-stu-id="2b551-183">The following example shows a <xref:System.Transactions.TransactionScope> object that creates three nested scope objects, each instantiated with a different <xref:System.Transactions.TransactionScopeOption> value.</span></span>  
  
```csharp  
using(TransactionScope scope1 = new TransactionScope())
//Default is Required
{
    using(TransactionScope scope2 = new TransactionScope(TransactionScopeOption.Required))
    {
        //...
    }

    using(TransactionScope scope3 = new TransactionScope(TransactionScopeOption.RequiresNew))   
    {
        //...  
    }
  
    using(TransactionScope scope4 = new TransactionScope(TransactionScopeOption.Suppress))
    {
        //...  
    }
}
```  
  
 <span data-ttu-id="2b551-184">L'esempio mostra un blocco di codice in cui non esiste alcuna transazione di ambiente che crea un nuovo ambito (`scope1`) con l'opzione <xref:System.Transactions.TransactionScopeOption.Required>.</span><span class="sxs-lookup"><span data-stu-id="2b551-184">The example shows a code block without any ambient transaction creating a new scope (`scope1`) with <xref:System.Transactions.TransactionScopeOption.Required>.</span></span> <span data-ttu-id="2b551-185">L'ambito `scope1` è un ambito radice in quanto crea una nuova transazione (Transazione A) che definisce come transazione di ambiente.</span><span class="sxs-lookup"><span data-stu-id="2b551-185">The scope `scope1` is a root scope as it creates a new transaction (Transaction A) and makes Transaction A the ambient transaction.</span></span> <span data-ttu-id="2b551-186">In `Scope1` quindi vengono creati tre nuovi oggetti, ciascuno con un valore diverso di <xref:System.Transactions.TransactionScopeOption>.</span><span class="sxs-lookup"><span data-stu-id="2b551-186">`Scope1` then creates three more objects, each with a different <xref:System.Transactions.TransactionScopeOption> value.</span></span> <span data-ttu-id="2b551-187">Ad esempio, l'ambito `scope2` viene creato con l'opzione <xref:System.Transactions.TransactionScopeOption.Required> e, poiché esiste una transazione di ambiente, si aggiunge alla prima transazione creata dall'ambito `scope1`.</span><span class="sxs-lookup"><span data-stu-id="2b551-187">For example, `scope2` is created with <xref:System.Transactions.TransactionScopeOption.Required>, and since there is an ambient transaction, it joins the first transaction created by `scope1`.</span></span> <span data-ttu-id="2b551-188">Si noti che l'ambito `scope3` è l'ambito radice di una nuova transazione e che l'ambito `scope4` è privo di transazione di ambiente.</span><span class="sxs-lookup"><span data-stu-id="2b551-188">Note that `scope3` is the root scope of a new transaction, and that `scope4` has no ambient transaction.</span></span>  
  
 <span data-ttu-id="2b551-189">Benché il valore predefinito e più comunemente utilizzato dell'enumerazione <xref:System.Transactions.TransactionScopeOption> sia l'opzione <xref:System.Transactions.TransactionScopeOption.Required>, ognuno degli altri valori presenta uno scopo specifico.</span><span class="sxs-lookup"><span data-stu-id="2b551-189">Although the default and most commonly used value of <xref:System.Transactions.TransactionScopeOption> is <xref:System.Transactions.TransactionScopeOption.Required>, each of the other values has its unique purpose.</span></span>  

### <a name="non-transactional-code-inside-a-transaction-scope"></a><span data-ttu-id="2b551-190">Codice non transazionale all'interno di un ambito di transazione</span><span class="sxs-lookup"><span data-stu-id="2b551-190">Non-transactional code inside a transaction scope</span></span>

 <span data-ttu-id="2b551-191">L'opzione <xref:System.Transactions.TransactionScopeOption.Suppress> è utile quando si desidera preservare le operazioni eseguite dalla sezione di codice e non si desidera interrompere la transazione di ambiente se le operazioni hanno esito negativo.</span><span class="sxs-lookup"><span data-stu-id="2b551-191"><xref:System.Transactions.TransactionScopeOption.Suppress> is useful when you want to preserve the operations performed by the code section, and do not want to abort the ambient transaction if the operations fail.</span></span> <span data-ttu-id="2b551-192">Ad esempio, questa opzione è utile quando si desidera eseguire operazioni di registrazione o di controllo, o quando si desidera pubblicare eventi agli iscritti, sia che la transazione di ambiente venga interrotta sia che ne venga eseguito il commit.</span><span class="sxs-lookup"><span data-stu-id="2b551-192">For example, when you want to perform logging or audit operations, or when you want to publish events to subscribers regardless of whether your ambient transaction commits or aborts.</span></span> <span data-ttu-id="2b551-193">Questo valore consente di includere una sezione di codice non transazionale in un ambito di transazione, come mostrato nell'esempio seguente.</span><span class="sxs-lookup"><span data-stu-id="2b551-193">This value allows you to have a non-transactional code section inside a transaction scope, as shown in the following example.</span></span>  
  
```csharp  
using(TransactionScope scope1 = new TransactionScope())
{
    try
    {
        //Start of non-transactional section
        using(TransactionScope scope2 = new
            TransactionScope(TransactionScopeOption.Suppress))  
        {  
            //Do non-transactional work here  
        }  
        //Restores ambient transaction here
   }
   catch {}  
   //Rest of scope1
}
```  
  
### <a name="voting-inside-a-nested-scope"></a><span data-ttu-id="2b551-194">Votazione all'interno di un ambito annidato</span><span class="sxs-lookup"><span data-stu-id="2b551-194">Voting inside a nested scope</span></span>  
 <span data-ttu-id="2b551-195">Anche se un ambito annidato può aggiungersi alla transazione di ambiente dell'ambito radice, una chiamata al metodo <xref:System.Transactions.TransactionScope.Complete%2A> nell'ambito annidato non produce alcun effetto nell'ambito radice.</span><span class="sxs-lookup"><span data-stu-id="2b551-195">Although a nested scope can join the ambient transaction of the root scope, calling <xref:System.Transactions.TransactionScope.Complete%2A> in the nested scope has no affect on the root scope.</span></span> <span data-ttu-id="2b551-196">Il commit della transazione viene eseguito soltanto se tutti gli ambiti dall'ambito radice, dal primo all'ultimo livello di annidamento, votano a favore del commit.</span><span class="sxs-lookup"><span data-stu-id="2b551-196">Only if all the scopes from the root scope down to the last nested scope vote to commit the transaction, will the transaction be committed.</span></span> <span data-ttu-id="2b551-197">La mancata chiamata a <xref:System.Transactions.TransactionScope.Complete%2A> in un ambito annidato influirà sull'ambito radice, in quanto la transazione di ambiente verrà interrotta immediatamente.</span><span class="sxs-lookup"><span data-stu-id="2b551-197">Not calling <xref:System.Transactions.TransactionScope.Complete%2A> in a nested scope will affect the root scope as the ambient transaction will immediately be aborted.</span></span>  
  
## <a name="setting-the-transactionscope-timeout"></a><span data-ttu-id="2b551-198">Impostazione del timeout di TransactionScope</span><span class="sxs-lookup"><span data-stu-id="2b551-198">Setting the TransactionScope timeout</span></span>  
 <span data-ttu-id="2b551-199">Alcuni overload dei costruttori dell'ambito <xref:System.Transactions.TransactionScope> accettano un valore di tipo <xref:System.TimeSpan> utilizzato per controllare il timeout della transazione.</span><span class="sxs-lookup"><span data-stu-id="2b551-199">Some of the overloaded constructors of <xref:System.Transactions.TransactionScope> accept a value of type <xref:System.TimeSpan>, which is used to control the timeout of the transaction.</span></span> <span data-ttu-id="2b551-200">Un timeout impostato su zero equivale a un timeout infinito.</span><span class="sxs-lookup"><span data-stu-id="2b551-200">A timeout set to zero means an infinite timeout.</span></span> <span data-ttu-id="2b551-201">Un timeout infinito è particolarmente utile per l'esecuzione del debug, quando si desidera che il timeout della transazione di cui si sta eseguendo il debug non scada mentre si esegue il codice un'istruzione alla volta allo scopo di isolare un problema nella regola business.</span><span class="sxs-lookup"><span data-stu-id="2b551-201">Infinite timeout is useful mostly for debugging, when you want to isolate a problem in your business logic by stepping through your code, and you do not want the transaction you debug to time out while you attempt to locate the problem.</span></span> <span data-ttu-id="2b551-202">In tutti gli altri casi occorre prestare particolare attenzione quando si utilizza un timeout infinto, in quanto questo tipo timeout è in grado di aggirare tutti i meccanismi di protezione contro i deadlock delle transazioni.</span><span class="sxs-lookup"><span data-stu-id="2b551-202">Be extremely careful using the infinite timeout value in all other cases, because it overrides the safeguards against transaction deadlocks.</span></span>  
  
 <span data-ttu-id="2b551-203">In genere il timeout di un ambito <xref:System.Transactions.TransactionScope> viene impostato su un valore diverso da quello predefinito in due casi.</span><span class="sxs-lookup"><span data-stu-id="2b551-203">You typically set the <xref:System.Transactions.TransactionScope> timeout to values other than default in two cases.</span></span> <span data-ttu-id="2b551-204">Il primo è in fase di sviluppo, quando si desidera verificare il modo in cui le applicazioni gestiscono le transazioni interrotte.</span><span class="sxs-lookup"><span data-stu-id="2b551-204">The first is during development, when you want to test the way your application handles aborted transactions.</span></span> <span data-ttu-id="2b551-205">Se si imposta il timeout su un valore ridotto (ad esempio su un millisecondo) è possibile fare in modo che la transazione abbia esito negativo e quindi esaminare il codice di gestione degli errori.</span><span class="sxs-lookup"><span data-stu-id="2b551-205">By setting the timeout to a small value (such as one millisecond), you cause your transaction to fail and can thus observe your error handling code.</span></span> <span data-ttu-id="2b551-206">Il secondo caso in cui è utile impostare il timeout su un valore inferiore a quello predefinito è quando si sospetta che l'ambito sia coinvolto in un conflitto di risorse che genera deadlock.</span><span class="sxs-lookup"><span data-stu-id="2b551-206">The second case in which you set the value to be less than the default timeout is when you believe that the scope is involved in resource contention, resulting in deadlocks.</span></span> <span data-ttu-id="2b551-207">In tal caso lo scopo è interrompere la transazione il prima possibile senza attendere lo scadere del timeout predefinito.</span><span class="sxs-lookup"><span data-stu-id="2b551-207">In that case, you want to abort the transaction as soon as possible and not wait for the default timeout to expire.</span></span>  
  
 <span data-ttu-id="2b551-208">Quando un ambito si aggiunge a una transazione specificando un timeout minore rispetto a quello impostato per la transazione di ambiente, il nuovo timeout ridotto viene applicato all'oggetto <xref:System.Transactions.TransactionScope> e l'ambito deve terminare entro il timeout annidato specificato; in caso contrario la transazione viene interrotta automaticamente.</span><span class="sxs-lookup"><span data-stu-id="2b551-208">When a scope joins an ambient transaction but specifies a smaller timeout than the one the ambient transaction is set to, the new, shorter timeout is enforced on the <xref:System.Transactions.TransactionScope> object, and the scope must end within the nested time specified, or the transaction is automatically aborted.</span></span> <span data-ttu-id="2b551-209">Se il timeout dell'ambito annidato è maggiore rispetto a quello della transazione di ambiente, tale timeout viene ignorato.</span><span class="sxs-lookup"><span data-stu-id="2b551-209">If the nested scope's timeout is more than that of the ambient transaction, it has no effect.</span></span>  
  
## <a name="setting-the-transactionscope-isolation-level"></a><span data-ttu-id="2b551-210">Impostazione del livello di isolamento di TransactionScope</span><span class="sxs-lookup"><span data-stu-id="2b551-210">Setting the TransactionScope isolation level</span></span>  
 <span data-ttu-id="2b551-211">Alcuni overload dei costruttori dell'ambito <xref:System.Transactions.TransactionScope> accettano una struttura di tipo <xref:System.Transactions.TransactionOptions> per specificare, oltre a un valore di timeout, anche un livello di isolamento.</span><span class="sxs-lookup"><span data-stu-id="2b551-211">Some of the overloaded constructors of <xref:System.Transactions.TransactionScope> accept a structure of type <xref:System.Transactions.TransactionOptions> to specify an isolation level, in addition to a timeout value.</span></span> <span data-ttu-id="2b551-212">Per impostazione predefinita, la transazione viene eseguita con il livello di isolamento impostato su <xref:System.Transactions.IsolationLevel.Serializable>.</span><span class="sxs-lookup"><span data-stu-id="2b551-212">By default, the transaction executes with isolation level set to <xref:System.Transactions.IsolationLevel.Serializable>.</span></span> <span data-ttu-id="2b551-213">I livelli di isolamento diversi da <xref:System.Transactions.IsolationLevel.Serializable> vengono in genere utilizzati nei sistemi caratterizzati da un numero elevato di operazioni di lettura.</span><span class="sxs-lookup"><span data-stu-id="2b551-213">Selecting an isolation level other than <xref:System.Transactions.IsolationLevel.Serializable> is commonly used for read-intensive systems.</span></span> <span data-ttu-id="2b551-214">Per utilizzare questi livelli è necessario aver compreso in modo chiaro la teoria dell'elaborazione delle transazioni, la semantica delle transazioni stesse, le problematiche di concorrenza attinenti e le conseguenze sulla coerenza di sistema.</span><span class="sxs-lookup"><span data-stu-id="2b551-214">This requires a solid understanding of transaction processing theory and the semantics of the transaction itself, the concurrency issues involved, and the consequences for system consistency.</span></span>  
  
 <span data-ttu-id="2b551-215">Inoltre, solo determinati gestori di risorse supportano tutti i livelli di isolamento ed è peraltro possibile che i gestori scelgano di partecipare alla transazione a un livello superiore rispetto a quello configurato.</span><span class="sxs-lookup"><span data-stu-id="2b551-215">In addition, not all resource managers support all levels of isolation, and they may elect to take part in the transaction at a higher level than the one configured.</span></span>  
  
 <span data-ttu-id="2b551-216">Ad eccezione di <xref:System.Transactions.IsolationLevel.Serializable>, tutti i livelli di isolamento possono comportare problemi di coerenza dovuti alla possibilità che altre transazioni accedano alle stesse informazioni.</span><span class="sxs-lookup"><span data-stu-id="2b551-216">Every isolation level besides <xref:System.Transactions.IsolationLevel.Serializable> is susceptible to inconsistency resulting from other transactions accessing the same information.</span></span> <span data-ttu-id="2b551-217">La differenza tra i vari livelli di isolamento consiste nel modo in cui utilizzano i blocchi di lettura e di scrittura.</span><span class="sxs-lookup"><span data-stu-id="2b551-217">The difference between the different isolation levels is in the way read and write locks are used.</span></span> <span data-ttu-id="2b551-218">Un blocco può essere tenuto attivo esclusivamente quando la transazione accede ai dati del gestore di risorse, oppure fino all'interruzione o all'esecuzione del commit della transazione.</span><span class="sxs-lookup"><span data-stu-id="2b551-218">A lock can be held only when the transaction accesses the data in the resource manager, or it can be held until the transaction is committed or aborted.</span></span> <span data-ttu-id="2b551-219">Il primo tipo di blocco consente di ottimizzare la velocità effettiva, mentre il secondo è ideale per garantire la coerenza.</span><span class="sxs-lookup"><span data-stu-id="2b551-219">The former is better for throughput, the latter for consistency.</span></span> <span data-ttu-id="2b551-220">I due tipi di blocco e i due tipi di operazioni (lettura/scrittura) danno luogo a quattro livelli di isolamento di base.</span><span class="sxs-lookup"><span data-stu-id="2b551-220">The two kinds of locks and the two kinds of operations (read/write) give four basic isolation levels.</span></span> <span data-ttu-id="2b551-221">Per altre informazioni, vedere <xref:System.Transactions.IsolationLevel>.</span><span class="sxs-lookup"><span data-stu-id="2b551-221">See <xref:System.Transactions.IsolationLevel> for more information.</span></span>  
  
 <span data-ttu-id="2b551-222">Quando si utilizzano oggetti <xref:System.Transactions.TransactionScope> annidati, tutti gli ambiti annidati devono essere configurati in modo da utilizzare esattamente lo stesso livello di isolamento se intendono aggiungersi alla transazione di ambiente.</span><span class="sxs-lookup"><span data-stu-id="2b551-222">When using nested <xref:System.Transactions.TransactionScope> objects, all nested scopes must be configured to use exactly the same isolation level if they want to join the ambient transaction.</span></span> <span data-ttu-id="2b551-223">Se un oggetto <xref:System.Transactions.TransactionScope> annidato tenta di aggiungersi alla transazione di ambiente specificando un livello di isolamento diverso, viene generata un'eccezione <xref:System.ArgumentException>.</span><span class="sxs-lookup"><span data-stu-id="2b551-223">If a nested <xref:System.Transactions.TransactionScope> object tries to join the ambient transaction yet it specifies a different isolation level, an <xref:System.ArgumentException> is thrown.</span></span>  
  
## <a name="interop-with-com"></a><span data-ttu-id="2b551-224">Interoperabilità con COM+</span><span class="sxs-lookup"><span data-stu-id="2b551-224">Interop with COM+</span></span>  
 <span data-ttu-id="2b551-225">Quando si crea una nuova istanza della classe <xref:System.Transactions.TransactionScope> è possibile utilizzare l'enumerazione <xref:System.Transactions.EnterpriseServicesInteropOption> in uno dei costruttori per specificare l'interoperabilità con COM+.</span><span class="sxs-lookup"><span data-stu-id="2b551-225">When you create a new <xref:System.Transactions.TransactionScope> instance, you can use the <xref:System.Transactions.EnterpriseServicesInteropOption> enumeration in one of the constructors to specify how to interact with COM+.</span></span> <span data-ttu-id="2b551-226">Per ulteriori informazioni, vedere [interoperabilità con Enterprise Services e transazioni com+](interoperability-with-enterprise-services-and-com-transactions.md).</span><span class="sxs-lookup"><span data-stu-id="2b551-226">For more information on this, see [Interoperability with Enterprise Services and COM+ Transactions](interoperability-with-enterprise-services-and-com-transactions.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="2b551-227">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="2b551-227">See also</span></span>

- <xref:System.Transactions.Transaction.Clone%2A>
- <xref:System.Transactions.TransactionScope>
