---
title: Scrittura dinamica sicura in SQL Server
ms.date: 03/30/2017
ms.assetid: df5512b0-c249-40d2-82f9-f9a2ce6665bc
ms.openlocfilehash: c02455ba8798df1de1d52f6b4db3426d41b95daf
ms.sourcegitcommit: d2e1dfa7ef2d4e9ffae3d431cf6a4ffd9c8d378f
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 09/07/2019
ms.locfileid: "70791415"
---
# <a name="writing-secure-dynamic-sql-in-sql-server"></a><span data-ttu-id="23f8d-102">Scrittura dinamica sicura in SQL Server</span><span class="sxs-lookup"><span data-stu-id="23f8d-102">Writing Secure Dynamic SQL in SQL Server</span></span>
<span data-ttu-id="23f8d-103">Per SQL injection si intende il processo mediante il quale un utente malintenzionato immette istruzioni Transact-SQL anziché input valido.</span><span class="sxs-lookup"><span data-stu-id="23f8d-103">SQL Injection is the process by which a malicious user enters Transact-SQL statements instead of valid input.</span></span> <span data-ttu-id="23f8d-104">Se l'input viene passato direttamente al server senza essere convalidato e se l'applicazione esegue inavvertitamente il codice inserito, è possibile che l'attacco danneggi o elimini definitivamente i dati.</span><span class="sxs-lookup"><span data-stu-id="23f8d-104">If the input is passed directly to the server without being validated and if the application inadvertently executes the injected code, the attack has the potential to damage or destroy data.</span></span>  
  
 <span data-ttu-id="23f8d-105">Per la prevenzione degli attacchi di questo tipo è necessario esaminare tutte le procedure che creano istruzioni SQL, poiché in SQL Server vengono eseguite tutte le query sintatticamente valide ricevute.</span><span class="sxs-lookup"><span data-stu-id="23f8d-105">Any procedure that constructs SQL statements should be reviewed for injection vulnerabilities because SQL Server will execute all syntactically valid queries that it receives.</span></span> <span data-ttu-id="23f8d-106">Anche i dati con parametri possono essere modificati da un utente malintenzionato abile e determinato.</span><span class="sxs-lookup"><span data-stu-id="23f8d-106">Even parameterized data can be manipulated by a skilled and determined attacker.</span></span> <span data-ttu-id="23f8d-107">Se si usano istruzioni SQL dinamiche, aggiungere parametri ai comandi e non includere mai i valori dei parametri direttamente nella stringa di query.</span><span class="sxs-lookup"><span data-stu-id="23f8d-107">If you use dynamic SQL, be sure to parameterize your commands, and never include parameter values directly into the query string.</span></span>  
  
## <a name="anatomy-of-a-sql-injection-attack"></a><span data-ttu-id="23f8d-108">Anatomia di un attacco SQL injection</span><span class="sxs-lookup"><span data-stu-id="23f8d-108">Anatomy of a SQL Injection Attack</span></span>  
 <span data-ttu-id="23f8d-109">Il processo di injection termina prematuramente una stringa di testo e aggiunge un nuovo comando.</span><span class="sxs-lookup"><span data-stu-id="23f8d-109">The injection process works by prematurely terminating a text string and appending a new command.</span></span> <span data-ttu-id="23f8d-110">Poiché prima che venga eseguito è possibile che al comando inserito vengano aggiunte ulteriori stringhe, l'utente malintenzionato termina la stringa inserita con un contrassegno di commento "--".</span><span class="sxs-lookup"><span data-stu-id="23f8d-110">Because the inserted command may have additional strings appended to it before it is executed, the malefactor terminates the injected string with a comment mark "--".</span></span> <span data-ttu-id="23f8d-111">In fase di esecuzione il testo che segue il contrassegno di commento viene ignorato.</span><span class="sxs-lookup"><span data-stu-id="23f8d-111">Subsequent text is ignored at execution time.</span></span> <span data-ttu-id="23f8d-112">È possibile inserire più comandi usando il punto e virgola (;) come delimitatore.</span><span class="sxs-lookup"><span data-stu-id="23f8d-112">Multiple commands can be inserted using a semicolon (;) delimiter.</span></span>  
  
 <span data-ttu-id="23f8d-113">Se il codice SQL inserito tramite injection è corretto dal punto di vista sintattico, le manomissioni non possono essere rilevate a livello di codice.</span><span class="sxs-lookup"><span data-stu-id="23f8d-113">As long as injected SQL code is syntactically correct, tampering cannot be detected programmatically.</span></span> <span data-ttu-id="23f8d-114">È pertanto necessario convalidare tutto l'input utente e esaminare attentamente il codice per l'esecuzione dei comandi SQL generati nel server in uso.</span><span class="sxs-lookup"><span data-stu-id="23f8d-114">Therefore, you must validate all user input and carefully review code that executes constructed SQL commands in the server that you are using.</span></span> <span data-ttu-id="23f8d-115">Non eseguire mai la concatenazione di input utente non convalidato.</span><span class="sxs-lookup"><span data-stu-id="23f8d-115">Never concatenate user input that is not validated.</span></span> <span data-ttu-id="23f8d-116">La concatenazione delle stringhe costituisce il punto di ingresso principale per un attacco script injection.</span><span class="sxs-lookup"><span data-stu-id="23f8d-116">String concatenation is the primary point of entry for script injection.</span></span>  
  
 <span data-ttu-id="23f8d-117">Di seguito sono riportate alcune linee guida utili.</span><span class="sxs-lookup"><span data-stu-id="23f8d-117">Here are some helpful guidelines:</span></span>  
  
- <span data-ttu-id="23f8d-118">Non compilare mai istruzioni Transact-SQL direttamente dall'input utente. Usare stored procedure per la convalida dell'input utente.</span><span class="sxs-lookup"><span data-stu-id="23f8d-118">Never build Transact-SQL statements directly from user input; use stored procedures to validate user input.</span></span>  
  
- <span data-ttu-id="23f8d-119">Convalidare l'input utente testando tipo, lunghezza, formato e intervallo.</span><span class="sxs-lookup"><span data-stu-id="23f8d-119">Validate user input by testing type, length, format, and range.</span></span> <span data-ttu-id="23f8d-120">Usare la funzione QUOTENAME() Transact-SQL per usare caratteri di escape per i nomi di sistema oppure la funzione REPLACE() per usare caratteri di escape per qualsiasi carattere di una stringa.</span><span class="sxs-lookup"><span data-stu-id="23f8d-120">Use the Transact-SQL QUOTENAME() function to escape system names or the REPLACE() function to escape any character in a string.</span></span>  
  
- <span data-ttu-id="23f8d-121">Implementare più livelli di convalida per ciascun livello dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="23f8d-121">Implement multiple layers of validation in each tier of your application.</span></span>  
  
- <span data-ttu-id="23f8d-122">Testare le dimensioni e il tipo di dati dell'input e imporre limiti appropriati.</span><span class="sxs-lookup"><span data-stu-id="23f8d-122">Test the size and data type of input and enforce appropriate limits.</span></span> <span data-ttu-id="23f8d-123">In questo modo è possibile impedire intenzionali sovraccarichi del buffer.</span><span class="sxs-lookup"><span data-stu-id="23f8d-123">This can help prevent deliberate buffer overruns.</span></span>  
  
- <span data-ttu-id="23f8d-124">Testare il contenuto delle variabili stringa e accettare solo i valori previsti.</span><span class="sxs-lookup"><span data-stu-id="23f8d-124">Test the content of string variables and accept only expected values.</span></span> <span data-ttu-id="23f8d-125">Rifiutare voci contenenti dati binari, sequenze di escape e caratteri di commento.</span><span class="sxs-lookup"><span data-stu-id="23f8d-125">Reject entries that contain binary data, escape sequences, and comment characters.</span></span>  
  
- <span data-ttu-id="23f8d-126">Quando si usano documenti XML, convalidare tutti i dati in base al relativo schema man mano che vengono immessi.</span><span class="sxs-lookup"><span data-stu-id="23f8d-126">When you are working with XML documents, validate all data against its schema as it is entered.</span></span>  
  
- <span data-ttu-id="23f8d-127">In ambienti multilivello è necessario convalidare tutti i dati prima di consentirne l'inserimento nell'area attendibile.</span><span class="sxs-lookup"><span data-stu-id="23f8d-127">In multi-tiered environments, all data should be validated before admission to the trusted zone.</span></span>  
  
- <span data-ttu-id="23f8d-128">Non accettare le stringhe seguenti nei campi da cui è possibile costruire i nomi file: AUX, CLOCK $, da COM1 a COM8, CON, CONFIG $, da LPT1 a LPT8, NUL e PRN.</span><span class="sxs-lookup"><span data-stu-id="23f8d-128">Do not accept the following strings in fields from which file names can be constructed: AUX, CLOCK$, COM1 through COM8, CON, CONFIG$, LPT1 through LPT8, NUL, and PRN.</span></span>  
  
- <span data-ttu-id="23f8d-129">Usare oggetti <xref:System.Data.SqlClient.SqlParameter> con stored procedure e comandi per fornire la verifica dei tipi e la convalida della lunghezza.</span><span class="sxs-lookup"><span data-stu-id="23f8d-129">Use <xref:System.Data.SqlClient.SqlParameter> objects with stored procedures and commands to provide type checking and length validation.</span></span>  
  
- <span data-ttu-id="23f8d-130">Usare espressioni <xref:System.Text.RegularExpressions.Regex> nel codice client per filtrare i caratteri non validi.</span><span class="sxs-lookup"><span data-stu-id="23f8d-130">Use <xref:System.Text.RegularExpressions.Regex> expressions in client code to filter invalid characters.</span></span>  
  
## <a name="dynamic-sql-strategies"></a><span data-ttu-id="23f8d-131">Strategie per le istruzioni SQL dinamiche</span><span class="sxs-lookup"><span data-stu-id="23f8d-131">Dynamic SQL Strategies</span></span>  
 <span data-ttu-id="23f8d-132">L'esecuzione di istruzioni SQL create in modo dinamico nel codice procedurale interrompe la catena di proprietà, facendo in modo che SQL Server controlli le autorizzazioni del chiamante sugli oggetti cui hanno accesso le istruzioni SQL dinamiche.</span><span class="sxs-lookup"><span data-stu-id="23f8d-132">Executing dynamically created SQL statements in your procedural code breaks the ownership chain, causing SQL Server to check the permissions of the caller against the objects being accessed by the dynamic SQL.</span></span>  
  
 <span data-ttu-id="23f8d-133">In SQL Server sono disponibili nuove tecniche per concedere agli utenti l'accesso ai dati usando stored procedure e funzioni definite dall'utente che eseguono istruzioni SQL dinamiche.</span><span class="sxs-lookup"><span data-stu-id="23f8d-133">SQL Server has methods for granting users access to data using stored procedures and user-defined functions that execute dynamic SQL.</span></span>  
  
- <span data-ttu-id="23f8d-134">Uso della rappresentazione con la clausola Transact-SQL EXECUTE AS, come descritto in [Personalizzazione delle autorizzazioni con rappresentazione in SQL Server](customizing-permissions-with-impersonation-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="23f8d-134">Using impersonation with the Transact-SQL EXECUTE AS clause, as described in [Customizing Permissions with Impersonation in SQL Server](customizing-permissions-with-impersonation-in-sql-server.md).</span></span>  
  
- <span data-ttu-id="23f8d-135">Firma di stored procedure con certificati, come descritto in [Firma di stored procedure in SQL Server](signing-stored-procedures-in-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="23f8d-135">Signing stored procedures with certificates, as described in [Signing Stored Procedures in SQL Server](signing-stored-procedures-in-sql-server.md).</span></span>  
  
### <a name="execute-as"></a><span data-ttu-id="23f8d-136">EXECUTE AS</span><span class="sxs-lookup"><span data-stu-id="23f8d-136">EXECUTE AS</span></span>  
 <span data-ttu-id="23f8d-137">La clausola EXECUTE AS sostituisce le autorizzazioni del chiamante con quelle dell'utente specificato nella clausola stessa.</span><span class="sxs-lookup"><span data-stu-id="23f8d-137">The EXECUTE AS clause replaces the permissions of the caller with that of the user specified in the EXECUTE AS clause.</span></span> <span data-ttu-id="23f8d-138">Le stored procedure o i trigger annidati vengono eseguiti nel contesto di sicurezza dell'utente proxy.</span><span class="sxs-lookup"><span data-stu-id="23f8d-138">Nested stored procedures or triggers execute under the security context of the proxy user.</span></span> <span data-ttu-id="23f8d-139">Tale comportamento può causare l'interruzione di applicazioni che si basano sulla sicurezza a livello di riga o che richiedono controlli.</span><span class="sxs-lookup"><span data-stu-id="23f8d-139">This can break applications that rely on row-level security or require auditing.</span></span> <span data-ttu-id="23f8d-140">Alcune funzioni che restituiscono l'identità dell'utente restituiscono in realtà l'utente associato alla clausola EXECUTE AS e non il chiamante originale.</span><span class="sxs-lookup"><span data-stu-id="23f8d-140">Some functions that return the identity of the user return the user specified in the EXECUTE AS clause, not the original caller.</span></span> <span data-ttu-id="23f8d-141">Viene ripristinato il contesto di esecuzione del chiamante originale solo dopo l'esecuzione della stored procedure o quando viene eseguita un'istruzione REVERT.</span><span class="sxs-lookup"><span data-stu-id="23f8d-141">Execution context is reverted to the original caller only after execution of the procedure or when a REVERT statement is issued.</span></span>  
  
### <a name="certificate-signing"></a><span data-ttu-id="23f8d-142">Firma dei certificati</span><span class="sxs-lookup"><span data-stu-id="23f8d-142">Certificate Signing</span></span>  
 <span data-ttu-id="23f8d-143">Quando viene eseguita una stored procedure firmata con un certificato, le autorizzazioni concesse all'utente del certificato vengono unite con quelle del chiamante.</span><span class="sxs-lookup"><span data-stu-id="23f8d-143">When a stored procedure that has been signed with a certificate executes, the permissions granted to the certificate user are merged with those of the caller.</span></span> <span data-ttu-id="23f8d-144">Il contesto di esecuzione rimane lo stesso. L'utente del certificato non rappresenta il chiamante.</span><span class="sxs-lookup"><span data-stu-id="23f8d-144">The execution context remains the same; the certificate user does not impersonate the caller.</span></span> <span data-ttu-id="23f8d-145">L'implementazione della firma delle stored procedure richiede l'esecuzione di numerosi passaggi.</span><span class="sxs-lookup"><span data-stu-id="23f8d-145">Signing stored procedures requires several steps to implement.</span></span> <span data-ttu-id="23f8d-146">Una stored procedure deve essere firmata nuovamente a ogni modifica.</span><span class="sxs-lookup"><span data-stu-id="23f8d-146">Each time the procedure is modified, it must be re-signed.</span></span>  
  
### <a name="cross-database-access"></a><span data-ttu-id="23f8d-147">Accesso tra database</span><span class="sxs-lookup"><span data-stu-id="23f8d-147">Cross Database Access</span></span>  
 <span data-ttu-id="23f8d-148">Il concatenamento della proprietà tra database non funziona nei casi in cui vengono eseguite istruzioni SQL create in modo dinamico.</span><span class="sxs-lookup"><span data-stu-id="23f8d-148">Cross-database ownership chaining does not work in cases where dynamically created SQL statements are executed.</span></span> <span data-ttu-id="23f8d-149">Per aggirare questo problema, in SQL Server è possibile creare una stored procedure che accede ai dati di un altro database e firmare la procedura con un certificato disponibile in entrambi i database.</span><span class="sxs-lookup"><span data-stu-id="23f8d-149">You can work around this in SQL Server by creating a stored procedure that accesses data in another database and signing the procedure with a certificate that exists in both databases.</span></span> <span data-ttu-id="23f8d-150">In questo modo si fornisce agli utenti l'accesso alle risorse del database usate dalla procedura senza concedere loro l'accesso o le autorizzazioni per il database.</span><span class="sxs-lookup"><span data-stu-id="23f8d-150">This gives users access to the database resources used by the procedure without granting them database access or permissions.</span></span>  
  
## <a name="external-resources"></a><span data-ttu-id="23f8d-151">Risorse esterne</span><span class="sxs-lookup"><span data-stu-id="23f8d-151">External Resources</span></span>  
 <span data-ttu-id="23f8d-152">Per altre informazioni, vedere le seguenti risorse.</span><span class="sxs-lookup"><span data-stu-id="23f8d-152">For more information, see the following resources.</span></span>  
  
|<span data-ttu-id="23f8d-153">Risorsa</span><span class="sxs-lookup"><span data-stu-id="23f8d-153">Resource</span></span>|<span data-ttu-id="23f8d-154">Descrizione</span><span class="sxs-lookup"><span data-stu-id="23f8d-154">Description</span></span>|  
|--------------|-----------------|  
|<span data-ttu-id="23f8d-155">[Stored procedure](/sql/relational-databases/stored-procedures/stored-procedures-database-engine) e [Attacco SQL Injection](/sql/relational-databases/security/sql-injection) nella documentazione online di SQL Server</span><span class="sxs-lookup"><span data-stu-id="23f8d-155">[Stored Procedures](/sql/relational-databases/stored-procedures/stored-procedures-database-engine) and [SQL Injection](/sql/relational-databases/security/sql-injection) in SQL Server Books Online</span></span>|<span data-ttu-id="23f8d-156">Viene descritto come creare stored procedure e come funziona SQL Injection.</span><span class="sxs-lookup"><span data-stu-id="23f8d-156">Topics describe how to create stored procedures and how SQL Injection works.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="23f8d-157">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="23f8d-157">See also</span></span>

- [<span data-ttu-id="23f8d-158">Protezione delle applicazioni ADO.NET</span><span class="sxs-lookup"><span data-stu-id="23f8d-158">Securing ADO.NET Applications</span></span>](../securing-ado-net-applications.md)
- [<span data-ttu-id="23f8d-159">Cenni preliminari sulla sicurezza in SQL Server</span><span class="sxs-lookup"><span data-stu-id="23f8d-159">Overview of SQL Server Security</span></span>](overview-of-sql-server-security.md)
- [<span data-ttu-id="23f8d-160">Scenari di sicurezza delle applicazioni in SQL Server</span><span class="sxs-lookup"><span data-stu-id="23f8d-160">Application Security Scenarios in SQL Server</span></span>](application-security-scenarios-in-sql-server.md)
- [<span data-ttu-id="23f8d-161">Gestione delle autorizzazioni con stored procedure in SQL Server</span><span class="sxs-lookup"><span data-stu-id="23f8d-161">Managing Permissions with Stored Procedures in SQL Server</span></span>](managing-permissions-with-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="23f8d-162">Firma di stored procedure in SQL Server</span><span class="sxs-lookup"><span data-stu-id="23f8d-162">Signing Stored Procedures in SQL Server</span></span>](signing-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="23f8d-163">Personalizzazione delle autorizzazioni con rappresentazione in SQL Server</span><span class="sxs-lookup"><span data-stu-id="23f8d-163">Customizing Permissions with Impersonation in SQL Server</span></span>](customizing-permissions-with-impersonation-in-sql-server.md)
- [<span data-ttu-id="23f8d-164">Panoramica di ADO.NET</span><span class="sxs-lookup"><span data-stu-id="23f8d-164">ADO.NET Overview</span></span>](../ado-net-overview.md)
