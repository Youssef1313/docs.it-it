---
title: Isolamento dello snapshot in SQL Server
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: 43ae5dd3-50f5-43a8-8d01-e37a61664176
ms.openlocfilehash: 6d85cc041850300d1d079b227dcb8ed9201a0502
ms.sourcegitcommit: 3094dcd17141b32a570a82ae3f62a331616e2c9c
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 10/01/2019
ms.locfileid: "71699067"
---
# <a name="snapshot-isolation-in-sql-server"></a><span data-ttu-id="63fd4-102">Isolamento dello snapshot in SQL Server</span><span class="sxs-lookup"><span data-stu-id="63fd4-102">Snapshot Isolation in SQL Server</span></span>
<span data-ttu-id="63fd4-103">L'isolamento dello snapshot migliora la concorrenza per le applicazioni OLTP.</span><span class="sxs-lookup"><span data-stu-id="63fd4-103">Snapshot isolation enhances concurrency for OLTP applications.</span></span>  
  
## <a name="understanding-snapshot-isolation-and-row-versioning"></a><span data-ttu-id="63fd4-104">Informazioni sull'isolamento dello snapshot e il controllo delle versioni delle righe</span><span class="sxs-lookup"><span data-stu-id="63fd4-104">Understanding Snapshot Isolation and Row Versioning</span></span>  
 <span data-ttu-id="63fd4-105">Una volta abilitato l'isolamento dello snapshot, è necessario mantenere aggiornate le versioni di riga per ogni transazione.</span><span class="sxs-lookup"><span data-stu-id="63fd4-105">Once snapshot isolation is enabled, updated row versions for each transaction must be maintained.</span></span>  <span data-ttu-id="63fd4-106">Prima del SQL Server 2019, queste versioni venivano archiviate in **tempdb**.</span><span class="sxs-lookup"><span data-stu-id="63fd4-106">Prior to SQL Server 2019, these versions were stored in **tempdb**.</span></span> <span data-ttu-id="63fd4-107">SQL Server 2019 introduce una nuova funzionalità, il recupero accelerato del database (ADR), che richiede un proprio set di versioni di riga.</span><span class="sxs-lookup"><span data-stu-id="63fd4-107">SQL Server 2019 introduces a new feature, Accelerated Database Recovery (ADR) which requires its own set of row versions.</span></span>  <span data-ttu-id="63fd4-108">Quindi, a partire da SQL Server 2019, se ADR non è abilitato, le versioni di riga vengono mantenute in **tempdb** come sempre.</span><span class="sxs-lookup"><span data-stu-id="63fd4-108">So, as of SQL Server 2019, if ADR is not enabled, row versions are kept in **tempdb** as always.</span></span>  <span data-ttu-id="63fd4-109">Se ADR è abilitato, tutte le versioni di riga, entrambe correlate all'isolamento dello snapshot e all'ADR, vengono mantenute nell'archivio versioni permanente (PVS) dell'ADR, che si trova nel database utente in un filegroup specificato dall'utente.</span><span class="sxs-lookup"><span data-stu-id="63fd4-109">If ADR is enabled, then all row versions, both related to snapshot isolation and ADR, are kept in ADR's Persistent Version Store (PVS), which is located in the user database in a filegroup which the user specifies.</span></span> <span data-ttu-id="63fd4-110">Ciascuna transazione viene identificata mediante un numero di sequenza univoco. Questi numeri vengono registrati per ciascuna versione di riga.</span><span class="sxs-lookup"><span data-stu-id="63fd4-110">A unique transaction sequence number identifies each transaction, and these unique numbers are recorded for each row version.</span></span> <span data-ttu-id="63fd4-111">La transazione funziona con le versioni di riga più recenti che dispongono di un numero di sequenza che precede il numero di sequenza della transazione.</span><span class="sxs-lookup"><span data-stu-id="63fd4-111">The transaction works with the most recent row versions having a sequence number before the sequence number of the transaction.</span></span> <span data-ttu-id="63fd4-112">La transazione ignora le versioni di riga più recenti, create dopo l'inizio della transazione stessa.</span><span class="sxs-lookup"><span data-stu-id="63fd4-112">Newer row versions created after the transaction has begun are ignored by the transaction.</span></span>  
  
 <span data-ttu-id="63fd4-113">Il termine "snapshot" è dovuto al fatto che tutte le query nella transazione rilevano la stessa versione, o snapshot, del database, in base allo stato del database all'inizio della transazione.</span><span class="sxs-lookup"><span data-stu-id="63fd4-113">The term "snapshot" reflects the fact that all queries in the transaction see the same version, or snapshot, of the database, based on the state of the database at the moment in time when the transaction begins.</span></span> <span data-ttu-id="63fd4-114">In una transazione snapshot non vengono acquisiti blocchi sulle pagine di dati o sulle righe di dati sottostanti. In questo modo è possibile eseguire altre transazioni senza che vengano bloccate da una precedente transazione non completata.</span><span class="sxs-lookup"><span data-stu-id="63fd4-114">No locks are acquired on the underlying data rows or data pages in a snapshot transaction, which permits other transactions to execute without being blocked by a prior uncompleted transaction.</span></span> <span data-ttu-id="63fd4-115">Le transazioni di modifica dei dati non bloccano le transazioni di lettura dei dati così come queste ultime non bloccano le transazioni di scrittura dei dati, esattamente come avviene nel livello di isolamento READ COMMITTED in SQL Server.</span><span class="sxs-lookup"><span data-stu-id="63fd4-115">Transactions that modify data do not block transactions that read data, and transactions that read data do not block transactions that write data, as they normally would under the default READ COMMITTED isolation level in SQL Server.</span></span> <span data-ttu-id="63fd4-116">Questo comportamento non bloccante riduce notevolmente la probabilità di blocchi critici per le transazioni complesse.</span><span class="sxs-lookup"><span data-stu-id="63fd4-116">This non-blocking behavior also significantly reduces the likelihood of deadlocks for complex transactions.</span></span>  
  
 <span data-ttu-id="63fd4-117">L'isolamento dello snapshot usa un modello di concorrenza ottimistica.</span><span class="sxs-lookup"><span data-stu-id="63fd4-117">Snapshot isolation uses an optimistic concurrency model.</span></span> <span data-ttu-id="63fd4-118">Se una transazione snapshot tenta di eseguire il commit delle modifiche apportate ai dati dall'inizio della transazione, verrà eseguito il rollback della transazione e verrà generato un errore.</span><span class="sxs-lookup"><span data-stu-id="63fd4-118">If a snapshot transaction attempts to commit modifications to data that has changed since the transaction began, the transaction will roll back and an error will be raised.</span></span> <span data-ttu-id="63fd4-119">Per evitare che questo si verifichi, è possibile usare i suggerimenti UPDLOCK per le istruzioni SELECT che accedono ai dati da modificare.</span><span class="sxs-lookup"><span data-stu-id="63fd4-119">You can avoid this by using UPDLOCK hints for SELECT statements that access data to be modified.</span></span> <span data-ttu-id="63fd4-120">Per altre informazioni, vedere l'argomento relativo agli hint di blocco nella documentazione online di SQL Server.</span><span class="sxs-lookup"><span data-stu-id="63fd4-120">See "Locking Hints" in SQL Server Books Online for more information.</span></span>  
  
 <span data-ttu-id="63fd4-121">L'isolamento dello snapshot deve essere abilitato impostando l'opzione di database ALLOW_SNAPSHOT_ISOLATION ON prima di usarlo per le transazioni.</span><span class="sxs-lookup"><span data-stu-id="63fd4-121">Snapshot isolation must be enabled by setting the ALLOW_SNAPSHOT_ISOLATION ON database option before it is used in transactions.</span></span> <span data-ttu-id="63fd4-122">Questo consente di attivare il meccanismo per l'archiviazione delle versioni di riga nel database temporaneo (**tempdb**).</span><span class="sxs-lookup"><span data-stu-id="63fd4-122">This activates the mechanism for storing row versions in the temporary database (**tempdb**).</span></span> <span data-ttu-id="63fd4-123">È necessario abilitare l'isolamento dello snapshot in ciascun database in cui esso viene usato con l'istruzione ALTER DATABASE di Transact-SQL.</span><span class="sxs-lookup"><span data-stu-id="63fd4-123">You must enable snapshot isolation in each database that uses it with the Transact-SQL ALTER DATABASE statement.</span></span> <span data-ttu-id="63fd4-124">In questo senso, l'isolamento dello snapshot differisce dai livelli di isolamento tradizionali di READ COMMITTED, REPEATABLE READ, SERIALIZABLE e READ UNCOMMITTED, che non richiedono alcuna configurazione.</span><span class="sxs-lookup"><span data-stu-id="63fd4-124">In this respect, snapshot isolation differs from the traditional isolation levels of READ COMMITTED, REPEATABLE READ, SERIALIZABLE, and READ UNCOMMITTED, which require no configuration.</span></span> <span data-ttu-id="63fd4-125">Le istruzioni seguenti attivano l'isolamento dello snapshot e sostituiscono il comportamento READ COMMITTED predefinito con SNAPSHOT:</span><span class="sxs-lookup"><span data-stu-id="63fd4-125">The following statements activate snapshot isolation and replace the default READ COMMITTED behavior with SNAPSHOT:</span></span>  
  
```sql  
ALTER DATABASE MyDatabase  
SET ALLOW_SNAPSHOT_ISOLATION ON  
  
ALTER DATABASE MyDatabase  
SET READ_COMMITTED_SNAPSHOT ON  
```  
  
 <span data-ttu-id="63fd4-126">L'impostazione dell'opzione READ_COMMITTED_SNAPSHOT ON consente di accedere alle righe la cui versione è stata controllata, al livello di isolamento READ COMMITTED predefinito.</span><span class="sxs-lookup"><span data-stu-id="63fd4-126">Setting the READ_COMMITTED_SNAPSHOT ON option allows access to versioned rows under the default READ COMMITTED isolation level.</span></span> <span data-ttu-id="63fd4-127">Se l'opzione READ_COMMITTED_SNAPSHOT è impostata su OFF, per accedere alle righe della versione è necessario impostare il livello di isolamento dello snapshot in maniera esplicita per ciascuna sessione.</span><span class="sxs-lookup"><span data-stu-id="63fd4-127">If the READ_COMMITTED_SNAPSHOT option is set to OFF, you must explicitly set the Snapshot isolation level for each session in order to access versioned rows.</span></span>  
  
## <a name="managing-concurrency-with-isolation-levels"></a><span data-ttu-id="63fd4-128">Gestione della concorrenza con livelli di isolamento</span><span class="sxs-lookup"><span data-stu-id="63fd4-128">Managing Concurrency with Isolation Levels</span></span>  
 <span data-ttu-id="63fd4-129">Il livello di isolamento al quale viene eseguita un'istruzione di Transact-SQL determina il comportamento di blocco e di controllo della versione della riga.</span><span class="sxs-lookup"><span data-stu-id="63fd4-129">The isolation level under which a Transact-SQL statement executes determines its locking and row versioning behavior.</span></span> <span data-ttu-id="63fd4-130">Un livello di isolamento dispone di un ambito di connessione, che, una volta impostato per una connessione con l'istruzione SET TRANSACTION ISOLATION LEVEL, rimane attivo finché non viene chiusa la connessione o non viene impostato un livello di isolamento diverso.</span><span class="sxs-lookup"><span data-stu-id="63fd4-130">An isolation level has connection-wide scope, and once set for a connection with the SET TRANSACTION ISOLATION LEVEL statement, it remains in effect until the connection is closed or another isolation level is set.</span></span> <span data-ttu-id="63fd4-131">Quando una connessione viene chiusa e restituita al pool, il livello di isolamento dall'ultima istruzione SET TRANSACTION ISOLATION LEVEL viene mantenuto.</span><span class="sxs-lookup"><span data-stu-id="63fd4-131">When a connection is closed and returned to the pool, the isolation level from the last SET TRANSACTION ISOLATION LEVEL statement is retained.</span></span> <span data-ttu-id="63fd4-132">Le successive connessioni che riutilizzano una connessione in pool usano il livello di isolamento che era attivo nel momento in cui la connessione è stata inserita nel pool.</span><span class="sxs-lookup"><span data-stu-id="63fd4-132">Subsequent connections reusing a pooled connection use the isolation level that was in effect at the time the connection is pooled.</span></span>  
  
 <span data-ttu-id="63fd4-133">Le singole query eseguite in una connessione possono contenere hint di blocco in grado di modificare l'isolamento per una singola istruzione o transazione, ma che non possono influire sul livello della connessione.</span><span class="sxs-lookup"><span data-stu-id="63fd4-133">Individual queries issued within a connection can contain lock hints that modify the isolation for a single statement or transaction but do not affect the isolation level of the connection.</span></span> <span data-ttu-id="63fd4-134">I livelli di isolamento o gli hint di blocco impostati in funzioni o stored procedure non modificano il livello di isolamento della connessione che li ha chiamati e restano validi solo per la durata della stored procedure o della chiamata di funzione.</span><span class="sxs-lookup"><span data-stu-id="63fd4-134">Isolation levels or lock hints set in stored procedures or functions do not change the isolation level of the connection that calls them and are in effect only for the duration of the stored procedure or function call.</span></span>  
  
 <span data-ttu-id="63fd4-135">I quattro livelli di isolamento definiti nello standard SQL-92 sono supportati nelle prime versioni di SQL Server:</span><span class="sxs-lookup"><span data-stu-id="63fd4-135">Four isolation levels defined in the SQL-92 standard were supported in early versions of SQL Server:</span></span>  
  
- <span data-ttu-id="63fd4-136">READ UNCOMMITTED rappresenta il livello di isolamento meno restrittivo perché ignora i blocchi inseriti da altre transazioni.</span><span class="sxs-lookup"><span data-stu-id="63fd4-136">READ UNCOMMITTED is the least restrictive isolation level because it ignores locks placed by other transactions.</span></span> <span data-ttu-id="63fd4-137">Le transazioni eseguite in READ UNCOMMITTED possono leggere i valori dei dati modificati non ancora sottoposti a commit da altre transazioni. Queste letture vengono definite "dirty".</span><span class="sxs-lookup"><span data-stu-id="63fd4-137">Transactions executing under READ UNCOMMITTED can read modified data values that have not yet been committed by other transactions; these are called "dirty" reads.</span></span>  
  
- <span data-ttu-id="63fd4-138">READ COMMITTED è il livello di isolamento predefinito per SQL Server.</span><span class="sxs-lookup"><span data-stu-id="63fd4-138">READ COMMITTED is the default isolation level for SQL Server.</span></span> <span data-ttu-id="63fd4-139">Questo livello consente di impedire le letture dirty, specificando che le istruzioni non possono leggere i valori dei dati modificati ma non ancora sottoposti a commit da altre transazioni.</span><span class="sxs-lookup"><span data-stu-id="63fd4-139">It prevents dirty reads by specifying that statements cannot read data values that have been modified but not yet committed by other transactions.</span></span> <span data-ttu-id="63fd4-140">Altre transazioni possono ancora modificare, inserire o eliminare dati tra le esecuzioni di singole istruzioni all'interno della transazione corrente, dando luogo a letture non ripetibili o dati "fantasma".</span><span class="sxs-lookup"><span data-stu-id="63fd4-140">Other transactions can still modify, insert, or delete data between executions of individual statements within the current transaction, resulting in non-repeatable reads, or "phantom" data.</span></span>  
  
- <span data-ttu-id="63fd4-141">REPEATABLE READ è un livello di isolamento più restrittivo di READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="63fd4-141">REPEATABLE READ is a more restrictive isolation level than READ COMMITTED.</span></span> <span data-ttu-id="63fd4-142">Esso include il livello READ COMMITTED e aggiunge la limitazione in base alla quale nessun'altra transazione può modificare o eliminare dati letti dalla transazione corrente finché questa non viene sottoposta a commit.</span><span class="sxs-lookup"><span data-stu-id="63fd4-142">It encompasses READ COMMITTED and additionally specifies that no other transactions can modify or delete data that has been read by the current transaction until the current transaction commits.</span></span> <span data-ttu-id="63fd4-143">La concorrenza è minore rispetto al livello READ COMMITTED in quanto i blocchi condivisi sui dati letti vengono conservati per la durata della transazione anziché rilasciati al termine di ciascuna istruzione.</span><span class="sxs-lookup"><span data-stu-id="63fd4-143">Concurrency is lower than for READ COMMITTED because shared locks on read data are held for the duration of the transaction instead of being released at the end of each statement.</span></span>  
  
- <span data-ttu-id="63fd4-144">SERIALIZABLE è il livello di isolamento più restrittivo, in quanto blocca intere gamme di chiavi e trattiene i blocchi finché la transazione non è stata completata.</span><span class="sxs-lookup"><span data-stu-id="63fd4-144">SERIALIZABLE is the most restrictive isolation level, because it locks entire ranges of keys and holds the locks until the transaction is complete.</span></span> <span data-ttu-id="63fd4-145">Esso include il livello REPEATABLE READ e aggiunge la limitazione in base alla quale altre transazioni non possono inserire nuove righe negli intervalli letti dalla transazione finché quest'ultima non è stata completata.</span><span class="sxs-lookup"><span data-stu-id="63fd4-145">It encompasses REPEATABLE READ and adds the restriction that other transactions cannot insert new rows into ranges that have been read by the transaction until the transaction is complete.</span></span>  
  
 <span data-ttu-id="63fd4-146">Per ulteriori informazioni, vedere la [Guida al blocco delle transazioni e al controllo delle versioni delle righe](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide).</span><span class="sxs-lookup"><span data-stu-id="63fd4-146">For more information, refer to the [Transaction Locking and Row Versioning Guide](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide).</span></span>  
  
### <a name="snapshot-isolation-level-extensions"></a><span data-ttu-id="63fd4-147">Estensione del livello di isolamento dello snapshot</span><span class="sxs-lookup"><span data-stu-id="63fd4-147">Snapshot Isolation Level Extensions</span></span>  
 <span data-ttu-id="63fd4-148">In SQL Server sono state introdotte estensioni ai livelli di isolamento SQL-92 sotto forma del livello di isolamento SNAPSHOT e un'implementazione aggiuntiva di READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="63fd4-148">SQL Server introduced extensions to the SQL-92 isolation levels with the introduction of the SNAPSHOT isolation level and an additional implementation of READ COMMITTED.</span></span> <span data-ttu-id="63fd4-149">Il livello di isolamento READ_COMMITTED_SNAPSHOT può sostituire READ COMMITTED per tutte le transazioni.</span><span class="sxs-lookup"><span data-stu-id="63fd4-149">The READ_COMMITTED_SNAPSHOT isolation level can transparently replace READ COMMITTED for all transactions.</span></span>  
  
- <span data-ttu-id="63fd4-150">L'isolamento SNAPSHOT specifica che i dati letti all'interno di una transazione non rifletteranno mai le modifiche apportate da altre transazioni simultanee.</span><span class="sxs-lookup"><span data-stu-id="63fd4-150">SNAPSHOT isolation specifies that data read within a transaction will never reflect changes made by other simultaneous transactions.</span></span> <span data-ttu-id="63fd4-151">La transazione usa le versioni delle righe dei dati esistenti al momento in cui tale transazione viene iniziata.</span><span class="sxs-lookup"><span data-stu-id="63fd4-151">The transaction uses the data row versions that exist when the transaction begins.</span></span> <span data-ttu-id="63fd4-152">Sui dati non viene posizionato alcun blocco al momento della lettura, quindi le transazioni SNAPSHOT non impediscono la scrittura di dati da parte di altre transazioni.</span><span class="sxs-lookup"><span data-stu-id="63fd4-152">No locks are placed on the data when it is read, so SNAPSHOT transactions do not block other transactions from writing data.</span></span> <span data-ttu-id="63fd4-153">Le transazioni di scrittura dei dati non bloccano la lettura dei dati da parte delle transazioni snapshot.</span><span class="sxs-lookup"><span data-stu-id="63fd4-153">Transactions that write data do not block snapshot transactions from reading data.</span></span> <span data-ttu-id="63fd4-154">È necessario abilitare l'isolamento dello snapshot impostando l'opzione di database ALLOW_SNAPSHOT_ISOLATION.</span><span class="sxs-lookup"><span data-stu-id="63fd4-154">You need to enable snapshot isolation by setting the ALLOW_SNAPSHOT_ISOLATION database option in order to use it.</span></span>  
  
- <span data-ttu-id="63fd4-155">L'opzione di database READ_COMMITTED_SNAPSHOT determina il comportamento del livello di isolamento READ COMMITTED predefinito quando nel database viene abilitato l'isolamento dello snapshot.</span><span class="sxs-lookup"><span data-stu-id="63fd4-155">The READ_COMMITTED_SNAPSHOT database option determines the behavior of the default READ COMMITTED isolation level when snapshot isolation is enabled in a database.</span></span> <span data-ttu-id="63fd4-156">Se non si specifica in maniera esplicita l'opzione READ_COMMITTED_SNAPSHOT ON, il livello READ COMMITTED viene applicato a tutte le transazioni implicite.</span><span class="sxs-lookup"><span data-stu-id="63fd4-156">If you do not explicitly specify READ_COMMITTED_SNAPSHOT ON, READ COMMITTED is applied to all implicit transactions.</span></span> <span data-ttu-id="63fd4-157">Ciò provoca lo stesso comportamento dell'impostazione READ_COMMITTED_SNAPSHOT OFF (predefinita).</span><span class="sxs-lookup"><span data-stu-id="63fd4-157">This produces the same behavior as setting READ_COMMITTED_SNAPSHOT OFF (the default).</span></span> <span data-ttu-id="63fd4-158">Quando è attiva l'impostazione READ_COMMITTED_SNAPSHOT OFF, il motore di database usa i blocchi condivisi per l'applicazione del livello di isolamento.</span><span class="sxs-lookup"><span data-stu-id="63fd4-158">When READ_COMMITTED_SNAPSHOT OFF is in effect, the Database Engine uses shared locks to enforce the default isolation level.</span></span> <span data-ttu-id="63fd4-159">Se si imposta l'opzione di database READ_COMMITTED_SNAPSHOT su ON, per impostazione predefinita il motore di database usa il controllo delle versioni delle righe e l'isolamento dello snapshot, anziché usare i blocchi per proteggere i dati.</span><span class="sxs-lookup"><span data-stu-id="63fd4-159">If you set the READ_COMMITTED_SNAPSHOT database option to ON, the database engine uses row versioning and snapshot isolation as the default, instead of using locks to protect the data.</span></span>  
  
## <a name="how-snapshot-isolation-and-row-versioning-work"></a><span data-ttu-id="63fd4-160">Funzionamento dell'isolamento dello snapshot e del controllo delle versioni delle righe</span><span class="sxs-lookup"><span data-stu-id="63fd4-160">How Snapshot Isolation and Row Versioning Work</span></span>  
 <span data-ttu-id="63fd4-161">Quando il livello di isolamento dello SNAPSHOT è abilitato, ogni volta che viene aggiornata una riga, il SQL Server motore di database archivia una copia della riga originale in **tempdb**e aggiunge un numero di sequenza della transazione alla riga.</span><span class="sxs-lookup"><span data-stu-id="63fd4-161">When the SNAPSHOT isolation level is enabled, each time a row is updated, the SQL Server Database Engine stores a copy of the original row in **tempdb**, and adds a transaction sequence number to the row.</span></span> <span data-ttu-id="63fd4-162">Di seguito è riportata la sequenza degli eventi che si verificano:</span><span class="sxs-lookup"><span data-stu-id="63fd4-162">The following is the sequence of events that occurs:</span></span>  
  
- <span data-ttu-id="63fd4-163">Viene avviata una nuova transazione alla quale viene assegnato un numero di sequenza.</span><span class="sxs-lookup"><span data-stu-id="63fd4-163">A new transaction is initiated, and it is assigned a transaction sequence number.</span></span>  
  
- <span data-ttu-id="63fd4-164">Il motore di database legge una riga all'interno della transazione e recupera la versione di riga da **tempdb** il cui numero di sequenza è più vicino a e minore di, il numero di sequenza della transazione.</span><span class="sxs-lookup"><span data-stu-id="63fd4-164">The Database Engine reads a row within the transaction and retrieves the row version from **tempdb** whose sequence number is closest to, and lower than, the transaction sequence number.</span></span>  
  
- <span data-ttu-id="63fd4-165">Il motore di database controlla se il numero di sequenza della transazione è presente nell'elenco dei numeri di sequenza delle transazioni attive non sottoposte a commit al momento dell'avvio della transazione snapshot.</span><span class="sxs-lookup"><span data-stu-id="63fd4-165">The Database Engine checks to see if the transaction sequence number is not in the list of transaction sequence numbers of the uncommitted transactions active when the snapshot transaction started.</span></span>  
  
- <span data-ttu-id="63fd4-166">La transazione legge la versione della riga da **tempdb** aggiornata al momento dell'avvio della transazione.</span><span class="sxs-lookup"><span data-stu-id="63fd4-166">The transaction reads the version of the row from **tempdb** that was current as of the start of the transaction.</span></span> <span data-ttu-id="63fd4-167">Non rileverà nuove righe inserite dopo che la transazione è stata avviata in quanto questi valori del numero di sequenza sono maggiori del valore del numero di sequenza della transazione.</span><span class="sxs-lookup"><span data-stu-id="63fd4-167">It will not see new rows inserted after the transaction was started because those sequence number values will be higher than the value of the transaction sequence number.</span></span>  
  
- <span data-ttu-id="63fd4-168">La transazione corrente vedrà le righe che sono state eliminate dopo l'inizio della transazione, perché in **tempdb** sarà presente una versione di riga con un valore numerico di sequenza inferiore.</span><span class="sxs-lookup"><span data-stu-id="63fd4-168">The current transaction will see rows that were deleted after the transaction began, because there will be a row version in **tempdb** with a lower sequence number value.</span></span>  
  
 <span data-ttu-id="63fd4-169">L'effetto dell'isolamento consiste nel fatto che la transazione rileva tutti i dati esattamente come erano al momento dell'avvio della transazione stessa, senza rispettare o posizionare blocchi sulle tabelle sottostanti.</span><span class="sxs-lookup"><span data-stu-id="63fd4-169">The net effect of snapshot isolation is that the transaction sees all of the data as it existed at the start of the transaction, without honoring or placing any locks on the underlying tables.</span></span> <span data-ttu-id="63fd4-170">Ciò può comportare un miglioramento delle prestazioni in situazioni di conflitto.</span><span class="sxs-lookup"><span data-stu-id="63fd4-170">This can result in performance improvements in situations where there is contention.</span></span>  
  
 <span data-ttu-id="63fd4-171">Una transazione snapshot usa sempre il controllo della concorrenza ottimistica, rifiutando blocchi che potrebbero impedire l'aggiornamento delle righe da parte di altre transazioni.</span><span class="sxs-lookup"><span data-stu-id="63fd4-171">A snapshot transaction always uses optimistic concurrency control, withholding any locks that would prevent other transactions from updating rows.</span></span> <span data-ttu-id="63fd4-172">Se una transazione snapshot tenta di eseguire il commit di un aggiornamento per una riga modificata dopo l'inizio della transazione, viene eseguito il rollback della transazione e viene generato un errore.</span><span class="sxs-lookup"><span data-stu-id="63fd4-172">If a snapshot transaction attempts to commit an update to a row that was changed after the transaction began, the transaction is rolled back, and an error is raised.</span></span>  
  
## <a name="working-with-snapshot-isolation-in-adonet"></a><span data-ttu-id="63fd4-173">Utilizzo dell'isolamento dello snapshot in ADO.NET</span><span class="sxs-lookup"><span data-stu-id="63fd4-173">Working with Snapshot Isolation in ADO.NET</span></span>  
 <span data-ttu-id="63fd4-174">L'isolamento dello snapshot è supportato in ADO.NET dalla classe <xref:System.Data.SqlClient.SqlTransaction>.</span><span class="sxs-lookup"><span data-stu-id="63fd4-174">Snapshot isolation is supported in ADO.NET by the <xref:System.Data.SqlClient.SqlTransaction> class.</span></span> <span data-ttu-id="63fd4-175">Se un database è stato abilitato per l'isolamento dello snapshot ma non è configurato per READ_COMMITTED_SNAPSHOT in, è necessario avviare un <xref:System.Data.SqlClient.SqlTransaction> usando il valore di enumerazione **IsolationLevel. snapshot** quando si chiama il metodo <xref:System.Data.SqlClient.SqlConnection.BeginTransaction%2A>.</span><span class="sxs-lookup"><span data-stu-id="63fd4-175">If a database has been enabled for snapshot isolation but is not configured for READ_COMMITTED_SNAPSHOT ON, you must initiate a <xref:System.Data.SqlClient.SqlTransaction> using the **IsolationLevel.Snapshot** enumeration value when calling the <xref:System.Data.SqlClient.SqlConnection.BeginTransaction%2A> method.</span></span> <span data-ttu-id="63fd4-176">Questo frammento di codice presuppone che la connessione sia un oggetto <xref:System.Data.SqlClient.SqlConnection> aperto.</span><span class="sxs-lookup"><span data-stu-id="63fd4-176">This code fragment assumes that connection is an open <xref:System.Data.SqlClient.SqlConnection> object.</span></span>  
  
```vb  
Dim sqlTran As SqlTransaction = _  
  connection.BeginTransaction(IsolationLevel.Snapshot)  
```  
  
```csharp  
SqlTransaction sqlTran =   
  connection.BeginTransaction(IsolationLevel.Snapshot);  
```  
  
### <a name="example"></a><span data-ttu-id="63fd4-177">Esempio</span><span class="sxs-lookup"><span data-stu-id="63fd4-177">Example</span></span>  
 <span data-ttu-id="63fd4-178">Nell'esempio seguente viene illustrato il comportamento dei diversi livelli di isolamento mediante il tentativo di accesso ai dati bloccati. Questo esempio non può essere usato nel codice di produzione.</span><span class="sxs-lookup"><span data-stu-id="63fd4-178">The following example demonstrates how the different isolation levels behave by attempting to access locked data, and it is not intended to be used in production code.</span></span>  
  
 <span data-ttu-id="63fd4-179">Il codice si connette al database di esempio **AdventureWorks** in SQL Server e crea una tabella denominata **TestSnapshot** e inserisce una riga di dati.</span><span class="sxs-lookup"><span data-stu-id="63fd4-179">The code connects to the **AdventureWorks** sample database in SQL Server and creates a table named **TestSnapshot** and inserts one row of data.</span></span> <span data-ttu-id="63fd4-180">Il codice usa l'istruzione ALTER DATABASE di Transact-SQL per attivare l'isolamento dello snapshot per il database, ma non imposta l'opzione READ_COMMITTED_SNAPSHOT, lasciando attivo il comportamento a livello di isolamento READ COMMITTED predefinito.</span><span class="sxs-lookup"><span data-stu-id="63fd4-180">The code uses the ALTER DATABASE Transact-SQL statement to turn on snapshot isolation for the database, but it does not set the READ_COMMITTED_SNAPSHOT option, leaving the default READ COMMITTED isolation-level behavior in effect.</span></span> <span data-ttu-id="63fd4-181">Nel codice vengono eseguite le seguenti azioni:</span><span class="sxs-lookup"><span data-stu-id="63fd4-181">The code then performs the following actions:</span></span>  
  
- <span data-ttu-id="63fd4-182">Inizia, ma non completa, sqlTransaction1, che usa il livello di isolamento SERIALIZABLE per avviare la transazione di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="63fd4-182">It begins, but does not complete, sqlTransaction1, which uses the SERIALIZABLE isolation level to start an update transaction.</span></span> <span data-ttu-id="63fd4-183">Ciò consente di bloccare la tabella.</span><span class="sxs-lookup"><span data-stu-id="63fd4-183">This has the effect of locking the table.</span></span>  
  
- <span data-ttu-id="63fd4-184">Viene aperta una seconda connessione e viene avviata una seconda transazione utilizzando il livello di isolamento dello SNAPSHOT per leggere i dati nella tabella **TestSnapshot** .</span><span class="sxs-lookup"><span data-stu-id="63fd4-184">It opens a second connection and initiates a second transaction using the SNAPSHOT isolation level to read the data in the **TestSnapshot** table.</span></span> <span data-ttu-id="63fd4-185">Poiché l'isolamento dello snapshot è abilitato, la transazione può leggere i dati esistenti prima che venga avviata sqlTransaction1.</span><span class="sxs-lookup"><span data-stu-id="63fd4-185">Because snapshot isolation is enabled, this transaction can read the data that existed before sqlTransaction1 started.</span></span>  
  
- <span data-ttu-id="63fd4-186">Apre una terza connessione e avvia una transazione usando il livello di isolamento READ COMMITTED per tentare di leggere i dati nella tabella.</span><span class="sxs-lookup"><span data-stu-id="63fd4-186">It opens a third connection and initiates a transaction using the READ COMMITTED isolation level to attempt to read the data in the table.</span></span> <span data-ttu-id="63fd4-187">In tal caso, il codice non può leggere i dati perché non è in grado di leggere informazioni successive al posizionamento dei blocchi sulla tabella nella prima transazione, pertanto verrà eseguito il timeout. Lo stesso risultato si ottiene con i livelli di isolamento REPEATABLE READ e SERIALIZABLE poiché questi non possono leggere le informazioni successive al posizionamento dei blocchi nella prima transazione.</span><span class="sxs-lookup"><span data-stu-id="63fd4-187">In this case, the code cannot read the data because it cannot read past the locks placed on the table in the first transaction and times out. The same result would occur if the REPEATABLE READ and SERIALIZABLE isolation levels were used because these isolation levels also cannot read past the locks placed in the first transaction.</span></span>  
  
- <span data-ttu-id="63fd4-188">Apre una quarta connessione e avvia una transazione usando il livello di isolamento READ UNCOMMITTED, che esegue una lettura dirty del valore del quale non è stato eseguito il commit in sqlTransaction1.</span><span class="sxs-lookup"><span data-stu-id="63fd4-188">It opens a fourth connection and initiates a transaction using the READ UNCOMMITTED isolation level, which performs a dirty read of the uncommitted value in sqlTransaction1.</span></span> <span data-ttu-id="63fd4-189">Se non è stato eseguito il commit della prima transazione, questo valore non può esistere nel database.</span><span class="sxs-lookup"><span data-stu-id="63fd4-189">This value may never actually exist in the database if the first transaction is not committed.</span></span>  
  
- <span data-ttu-id="63fd4-190">Esegue il rollback della prima transazione e si pulisce eliminando la tabella **TestSnapshot** e disattivando l'isolamento dello snapshot per il database **AdventureWorks** .</span><span class="sxs-lookup"><span data-stu-id="63fd4-190">It rolls back the first transaction and cleans up by deleting the **TestSnapshot** table and turning off snapshot isolation for the **AdventureWorks** database.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="63fd4-191">Negli esempi seguenti viene usata la stessa stringa di connessione con il pool di connessioni disattivato.</span><span class="sxs-lookup"><span data-stu-id="63fd4-191">The following examples use the same connection string with connection pooling turned off.</span></span> <span data-ttu-id="63fd4-192">Se una connessione è in pool, la reimpostazione del relativo livello di isolamento non implica quella del livello di isolamento nel server.</span><span class="sxs-lookup"><span data-stu-id="63fd4-192">If a connection is pooled, resetting its isolation level does not reset the isolation level at the server.</span></span> <span data-ttu-id="63fd4-193">Di conseguenza, le connessioni successive che usano la stessa connessione interna in pool vengono avviate con i livelli di isolamento impostati su quello della connessione in pool.</span><span class="sxs-lookup"><span data-stu-id="63fd4-193">As a result, subsequent connections that use the same pooled inner connection start with their isolation levels set to that of the pooled connection.</span></span> <span data-ttu-id="63fd4-194">In alternativa a disattivare il pool di connessioni, è possibile impostare il livello di isolamento in modo esplicito per ogni connessione.</span><span class="sxs-lookup"><span data-stu-id="63fd4-194">An alternative to turning off connection pooling is to set the isolation level explicitly for each connection.</span></span>  
  
 [!code-csharp[DataWorks SnapshotIsolation.Demo#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.Demo/CS/source.cs#1)]
 [!code-vb[DataWorks SnapshotIsolation.Demo#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.Demo/VB/source.vb#1)]  
  
### <a name="example"></a><span data-ttu-id="63fd4-195">Esempio</span><span class="sxs-lookup"><span data-stu-id="63fd4-195">Example</span></span>  
 <span data-ttu-id="63fd4-196">Nell'esempio seguente viene illustrato il comportamento dell'isolamento dello snapshot durante la modifica dei dati.</span><span class="sxs-lookup"><span data-stu-id="63fd4-196">The following example demonstrates the behavior of snapshot isolation when data is being modified.</span></span> <span data-ttu-id="63fd4-197">Nel codice vengono eseguite le seguenti azioni:</span><span class="sxs-lookup"><span data-stu-id="63fd4-197">The code performs the following actions:</span></span>  
  
- <span data-ttu-id="63fd4-198">Si connette al database di esempio **AdventureWorks** e Abilita l'isolamento dello snapshot.</span><span class="sxs-lookup"><span data-stu-id="63fd4-198">Connects to the **AdventureWorks** sample database and enables SNAPSHOT isolation.</span></span>  
  
- <span data-ttu-id="63fd4-199">Crea una tabella denominata **TestSnapshotUpdate** e inserisce tre righe di dati di esempio.</span><span class="sxs-lookup"><span data-stu-id="63fd4-199">Creates a table named **TestSnapshotUpdate** and inserts three rows of sample data.</span></span>  
  
- <span data-ttu-id="63fd4-200">Inizia, ma non completa, sqlTransaction1 usando l'isolamento SNAPSHOT.</span><span class="sxs-lookup"><span data-stu-id="63fd4-200">Begins, but does not complete, sqlTransaction1 using SNAPSHOT isolation.</span></span> <span data-ttu-id="63fd4-201">Nella transazione vengono selezionate tre righe di dati.</span><span class="sxs-lookup"><span data-stu-id="63fd4-201">Three rows of data are selected in the transaction.</span></span>  
  
- <span data-ttu-id="63fd4-202">Crea una seconda **SqlConnection** in **AdventureWorks** e crea una seconda transazione usando il livello di isolamento Read committed che aggiorna un valore in una delle righe selezionate in sqlTransaction1.</span><span class="sxs-lookup"><span data-stu-id="63fd4-202">Creates a second **SqlConnection** to **AdventureWorks** and creates a second transaction using the READ COMMITTED isolation level that updates a value in one of the rows selected in sqlTransaction1.</span></span>  
  
- <span data-ttu-id="63fd4-203">Esegue il commit di sqlTransaction2.</span><span class="sxs-lookup"><span data-stu-id="63fd4-203">Commits sqlTransaction2.</span></span>  
  
- <span data-ttu-id="63fd4-204">Torna a sqlTransaction1 e tenta di aggiornare la stessa riga di cui è già stato eseguito il commit da sqlTransaction1.</span><span class="sxs-lookup"><span data-stu-id="63fd4-204">Returns to sqlTransaction1 and attempts to update the same row that sqlTransaction1 already committed.</span></span> <span data-ttu-id="63fd4-205">Viene generato l'errore 3960 e viene eseguito il rollback automatico di sqlTransaction1.</span><span class="sxs-lookup"><span data-stu-id="63fd4-205">Error 3960 is raised, and sqlTransaction1 is rolled back automatically.</span></span> <span data-ttu-id="63fd4-206">**SqlException. Number** e **SqlException. Message** vengono visualizzati nella finestra della console.</span><span class="sxs-lookup"><span data-stu-id="63fd4-206">The **SqlException.Number** and **SqlException.Message** are displayed in the Console window.</span></span>  
  
- <span data-ttu-id="63fd4-207">Esegue il codice di pulizia per disattivare l'isolamento dello snapshot in **AdventureWorks** ed eliminare la tabella **TestSnapshotUpdate** .</span><span class="sxs-lookup"><span data-stu-id="63fd4-207">Executes clean-up code to turn off snapshot isolation in **AdventureWorks** and delete the **TestSnapshotUpdate** table.</span></span>  
  
 [!code-csharp[DataWorks SnapshotIsolation.DemoUpdate#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.DemoUpdate/CS/source.cs#1)]
 [!code-vb[DataWorks SnapshotIsolation.DemoUpdate#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SnapshotIsolation.DemoUpdate/VB/source.vb#1)]  
  
### <a name="using-lock-hints-with-snapshot-isolation"></a><span data-ttu-id="63fd4-208">Utilizzo degli hint di blocco con l'isolamento dello snapshot</span><span class="sxs-lookup"><span data-stu-id="63fd4-208">Using Lock Hints with Snapshot Isolation</span></span>  
 <span data-ttu-id="63fd4-209">Nell'esempio precedente la prima transazione seleziona i dati mentre una seconda transazione li aggiorna prima del completamento della prima transazione, causando un conflitto di aggiornamento nel momento in cui la prima transazione tenta di aggiornare la stessa riga.</span><span class="sxs-lookup"><span data-stu-id="63fd4-209">In the previous example, the first transaction selects data, and a second transaction updates the data before the first transaction is able to complete, causing an update conflict when the first transaction tries to update the same row.</span></span> <span data-ttu-id="63fd4-210">È possibile limitare le probabilità che si verifichi un conflitto di aggiornamento nelle transazioni snapshot a esecuzione prolungata fornendo hint di blocco all'inizio della transazione.</span><span class="sxs-lookup"><span data-stu-id="63fd4-210">You can reduce the chance of update conflicts in long-running snapshot transactions by supplying lock hints at the beginning of the transaction.</span></span> <span data-ttu-id="63fd4-211">Nell'istruzione SELECT seguente viene usato l'hint UPDLOCK per bloccare le righe selezionate:</span><span class="sxs-lookup"><span data-stu-id="63fd4-211">The following SELECT statement uses the UPDLOCK hint to lock the selected rows:</span></span>  
  
```sql  
SELECT * FROM TestSnapshotUpdate WITH (UPDLOCK)   
  WHERE PriKey BETWEEN 1 AND 3  
```  
  
 <span data-ttu-id="63fd4-212">L'utilizzo dell'hint di blocco UPDLOCK consente di bloccare eventuali tentativi di aggiornamento delle righe prima del completamento della prima transazione.</span><span class="sxs-lookup"><span data-stu-id="63fd4-212">Using the UPDLOCK lock hint blocks any rows attempting to update the rows before the first transaction completes.</span></span> <span data-ttu-id="63fd4-213">Ciò garantisce che non si verifichino conflitti quando le righe vengono aggiornate in seguito nella transazione.</span><span class="sxs-lookup"><span data-stu-id="63fd4-213">This guarantees that the selected rows have no conflicts when they are updated later in the transaction.</span></span> <span data-ttu-id="63fd4-214">Vedere l'argomento relativo agli hint di blocco nella documentazione online di SQL Server.</span><span class="sxs-lookup"><span data-stu-id="63fd4-214">See "Locking Hints" in SQL Server Books Online.</span></span>  
  
 <span data-ttu-id="63fd4-215">Se si verificano molti conflitti, l'isolamento dello snapshot potrebbe non rivelarsi la scelta migliore.</span><span class="sxs-lookup"><span data-stu-id="63fd4-215">If your application has many conflicts, snapshot isolation may not be the best choice.</span></span> <span data-ttu-id="63fd4-216">Gli hint devono essere usati solo se veramente necessari.</span><span class="sxs-lookup"><span data-stu-id="63fd4-216">Hints should only be used when really needed.</span></span> <span data-ttu-id="63fd4-217">L'applicazione non è stata progettata per essere basata sugli hint di blocco dell'operazione.</span><span class="sxs-lookup"><span data-stu-id="63fd4-217">Your application should not be designed so that it constantly relies on lock hints for its operation.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="63fd4-218">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="63fd4-218">See also</span></span>

- [<span data-ttu-id="63fd4-219">SQL Server e ADO.NET</span><span class="sxs-lookup"><span data-stu-id="63fd4-219">SQL Server and ADO.NET</span></span>](index.md)
- [<span data-ttu-id="63fd4-220">Panoramica di ADO.NET</span><span class="sxs-lookup"><span data-stu-id="63fd4-220">ADO.NET Overview</span></span>](../ado-net-overview.md)
- [<span data-ttu-id="63fd4-221">Guida al controllo delle versioni delle righe e dei blocchi delle transazioni</span><span class="sxs-lookup"><span data-stu-id="63fd4-221">Transaction Locking and Row Versioning Guide</span></span>](/sql/relational-databases/sql-server-transaction-locking-and-row-versioning-guide)
