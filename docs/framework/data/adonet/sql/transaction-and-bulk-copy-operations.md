---
title: Transazioni e operazioni di copia di massa
ms.date: 03/30/2017
dev_langs:
- csharp
- vb
ms.assetid: f6f0cbc9-f7bf-4d6e-875f-ad1ba0b4aa62
ms.openlocfilehash: 73c375f9acfd193680982994ed0852454cefebe5
ms.sourcegitcommit: d2e1dfa7ef2d4e9ffae3d431cf6a4ffd9c8d378f
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 09/07/2019
ms.locfileid: "70791439"
---
# <a name="transaction-and-bulk-copy-operations"></a><span data-ttu-id="febd3-102">Transazioni e operazioni di copia di massa</span><span class="sxs-lookup"><span data-stu-id="febd3-102">Transaction and Bulk Copy Operations</span></span>
<span data-ttu-id="febd3-103">Le operazioni di copia di massa possono essere eseguite come operazioni isolate oppure come un singolo passaggio di una transazione a più passaggi.</span><span class="sxs-lookup"><span data-stu-id="febd3-103">Bulk copy operations can be performed as isolated operations or as part of a multiple step transaction.</span></span> <span data-ttu-id="febd3-104">Quest'ultima opzione consente di eseguire più operazioni di copia bulk all'interno della stessa transazione, nonché di eseguire altre operazioni di database, ad esempio inserimenti, aggiornamenti ed eliminazioni, e di eseguire comunque il commit o il rollback dell'intera transazione.</span><span class="sxs-lookup"><span data-stu-id="febd3-104">This latter option enables you to perform more than one bulk copy operation within the same transaction, as well as perform other database operations (such as inserts, updates, and deletes) while still being able to commit or roll back the entire transaction.</span></span>  
  
 <span data-ttu-id="febd3-105">Per impostazione predefinita, un'operazione di copia di massa viene eseguita come operazione isolata.</span><span class="sxs-lookup"><span data-stu-id="febd3-105">By default, a bulk copy operation is performed as an isolated operation.</span></span> <span data-ttu-id="febd3-106">L'operazione avviene infatti in modalità non transazionale, pertanto non è possibile eseguirne il rollback.</span><span class="sxs-lookup"><span data-stu-id="febd3-106">The bulk copy operation occurs in a non-transacted way, with no opportunity for rolling it back.</span></span> <span data-ttu-id="febd3-107">Se è necessario eseguire il rollback di tutta o parte della copia bulk quando si verifica un errore, è possibile utilizzare <xref:System.Data.SqlClient.SqlBulkCopy>una transazione gestita da, eseguire l'operazione di copia bulk all'interno di una transazione esistente oppure essere integrata in un oggetto **System. Transactions**<xref:System.Transactions.Transaction>.</span><span class="sxs-lookup"><span data-stu-id="febd3-107">If you need to roll back all or part of the bulk copy when an error occurs, you can use a <xref:System.Data.SqlClient.SqlBulkCopy>-managed transaction, perform the bulk copy operation within an existing transaction, or be enlisted in a **System.Transactions**<xref:System.Transactions.Transaction>.</span></span>  
  
## <a name="performing-a-non-transacted-bulk-copy-operation"></a><span data-ttu-id="febd3-108">Esecuzione di un'operazione di copia di massa non transazionale</span><span class="sxs-lookup"><span data-stu-id="febd3-108">Performing a Non-transacted Bulk Copy Operation</span></span>  
 <span data-ttu-id="febd3-109">Nell'applicazione console seguente viene illustrato cosa si verifica se viene rilevato un errore durante un'operazione di copia di massa non transazionale.</span><span class="sxs-lookup"><span data-stu-id="febd3-109">The following Console application shows what happens when a non-transacted bulk copy operation encounters an error partway through the operation.</span></span>  
  
 <span data-ttu-id="febd3-110">Nell'esempio, la tabella di origine e la tabella di destinazione includono `Identity` ognuna una colonna denominata **ProductID**.</span><span class="sxs-lookup"><span data-stu-id="febd3-110">In the example, the source table and destination table each include an `Identity` column named **ProductID**.</span></span> <span data-ttu-id="febd3-111">Il codice prepara la tabella di destinazione eliminando tutte le righe e quindi inserendo una singola riga il cui **ProductID** è noto nella tabella di origine.</span><span class="sxs-lookup"><span data-stu-id="febd3-111">The code first prepares the destination table by deleting all rows and then inserting a single row whose **ProductID** is known to exist in the source table.</span></span> <span data-ttu-id="febd3-112">Per impostazione predefinita, nella tabella di destinazione viene generato un nuovo valore della colonna `Identity` per ciascuna riga aggiunta.</span><span class="sxs-lookup"><span data-stu-id="febd3-112">By default, a new value for the `Identity` column is generated in the destination table for each row added.</span></span> <span data-ttu-id="febd3-113">In questo esempio, invece, quando si apre la connessione viene impostata un'opzione che impone al processo di caricamento di massa l'uso dei valori `Identity` dalla tabella di origine.</span><span class="sxs-lookup"><span data-stu-id="febd3-113">In this example, an option is set when the connection is opened that forces the bulk load process to use the `Identity` values from the source table instead.</span></span>  
  
 <span data-ttu-id="febd3-114">Quando si esegue l'operazione di copia di massa, la proprietà <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A> è impostata su 10.</span><span class="sxs-lookup"><span data-stu-id="febd3-114">The bulk copy operation is executed with the <xref:System.Data.SqlClient.SqlBulkCopy.BatchSize%2A> property set to 10.</span></span> <span data-ttu-id="febd3-115">Se viene rilevata una riga non valida, viene generata un'eccezione.</span><span class="sxs-lookup"><span data-stu-id="febd3-115">When the operation encounters the invalid row, an exception is thrown.</span></span> <span data-ttu-id="febd3-116">Nel primo esempio, l'operazione di copia di massa è di tipo non transazionale.</span><span class="sxs-lookup"><span data-stu-id="febd3-116">In this first example, the bulk copy operation is non-transacted.</span></span> <span data-ttu-id="febd3-117">Viene eseguito il commit di tutti i batch copiati fino al rilevamento dell'errore, viene eseguito il rollback del batch contenente la chiave duplicata e l'operazione di copia di massa viene interrotta prima dell'elaborazione di altri batch.</span><span class="sxs-lookup"><span data-stu-id="febd3-117">All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="febd3-118">Questo esempio non verrà eseguito a meno che non siano state create le tabelle di lavoro come descritto in configurazione di esempio per la [copia bulk](bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="febd3-118">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](bulk-copy-example-setup.md).</span></span> <span data-ttu-id="febd3-119">Questo codice viene fornito per illustrare la sintassi per l'utilizzo solo di **SqlBulkCopy** .</span><span class="sxs-lookup"><span data-stu-id="febd3-119">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="febd3-120">Se le tabelle di origine e di destinazione si trovano nella stessa istanza di SQL Server, è più semplice e veloce utilizzare un'istruzione Transact`INSERT … SELECT` -SQL per copiare i dati.</span><span class="sxs-lookup"><span data-stu-id="febd3-120">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.DefaultTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.DefaultTransaction/VB/source.vb#1)]  
  
## <a name="performing-a-dedicated-bulk-copy-operation-in-a-transaction"></a><span data-ttu-id="febd3-121">Esecuzione di un'operazione di copia bulk dedicata in una transazione</span><span class="sxs-lookup"><span data-stu-id="febd3-121">Performing a Dedicated Bulk Copy Operation in a Transaction</span></span>  
 <span data-ttu-id="febd3-122">Per impostazione predefinita, un'operazione di copia bulk corrisponde alla relativa transazione.</span><span class="sxs-lookup"><span data-stu-id="febd3-122">By default, a bulk copy operation is its own transaction.</span></span> <span data-ttu-id="febd3-123">Per eseguire un'operazione di copia bulk dedicata, creare una nuova istanza del tipo <xref:System.Data.SqlClient.SqlBulkCopy> con una stringa di connessione oppure usare un oggetto <xref:System.Data.SqlClient.SqlConnection> esistente senza una transazione attiva.</span><span class="sxs-lookup"><span data-stu-id="febd3-123">When you want to perform a dedicated bulk copy operation, create a new instance of <xref:System.Data.SqlClient.SqlBulkCopy> with a connection string, or use an existing <xref:System.Data.SqlClient.SqlConnection> object without an active transaction.</span></span> <span data-ttu-id="febd3-124">In ciascuno scenario, l'operazione di copia bulk consente di creare la transazione e quindi di eseguirne il commit o il rollback.</span><span class="sxs-lookup"><span data-stu-id="febd3-124">In each scenario, the bulk copy operation creates, and then commits or rolls back the transaction.</span></span>  
  
 <span data-ttu-id="febd3-125">È possibile specificare in modo esplicito l'opzione <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> nel costruttore della classe <xref:System.Data.SqlClient.SqlBulkCopy> per fare in modo un'operazione di copia bulk venga eseguita nella relativa transazione e che quindi ogni batch dell'operazione di copia bulk venga eseguita in una transazione distinta.</span><span class="sxs-lookup"><span data-stu-id="febd3-125">You can explicitly specify the <xref:System.Data.SqlClient.SqlBulkCopyOptions.UseInternalTransaction> option in the <xref:System.Data.SqlClient.SqlBulkCopy> class constructor to explicitly cause a bulk copy operation to execute in its own transaction, causing each batch of the bulk copy operation to execute within a separate transaction.</span></span>  
  
> [!NOTE]
> <span data-ttu-id="febd3-126">Dal momento che vengono eseguiti batch diversi all'interno di transazioni distinte, se si verifica un errore durante l'operazione di copia di massa, verrà eseguito il rollback di tutte le righe del batch corrente, ma quelle del batch precedente resteranno nel database.</span><span class="sxs-lookup"><span data-stu-id="febd3-126">Since different batches are executed in different transactions, if an error occurs during the bulk copy operation, all the rows in the current batch will be rolled back, but rows from previous batches will remain in the database.</span></span>  
  
 <span data-ttu-id="febd3-127">La seguente applicazione console è analoga all'esempio precedente, con una sola eccezione: in questo esempio, l'operazione di copia di massa gestisce le relative transazioni.</span><span class="sxs-lookup"><span data-stu-id="febd3-127">The following console application is similar to the previous example, with one exception: In this example, the bulk copy operation manages its own transactions.</span></span> <span data-ttu-id="febd3-128">Viene eseguito il commit di tutti i batch copiati fino al rilevamento dell'errore, viene eseguito il rollback del batch contenente la chiave duplicata e l'operazione di copia di massa viene interrotta prima dell'elaborazione di altri batch.</span><span class="sxs-lookup"><span data-stu-id="febd3-128">All batches copied up to the point of the error are committed; the batch containing the duplicate key is rolled back, and the bulk copy operation is halted before processing any other batches.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="febd3-129">Questo esempio non verrà eseguito a meno che non siano state create le tabelle di lavoro come descritto in configurazione di esempio per la [copia bulk](bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="febd3-129">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](bulk-copy-example-setup.md).</span></span> <span data-ttu-id="febd3-130">Questo codice viene fornito per illustrare la sintassi per l'utilizzo solo di **SqlBulkCopy** .</span><span class="sxs-lookup"><span data-stu-id="febd3-130">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="febd3-131">Se le tabelle di origine e di destinazione si trovano nella stessa istanza di SQL Server, è più semplice e veloce utilizzare un'istruzione Transact`INSERT … SELECT` -SQL per copiare i dati.</span><span class="sxs-lookup"><span data-stu-id="febd3-131">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.InternalTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.InternalTransaction/VB/source.vb#1)]  
  
## <a name="using-existing-transactions"></a><span data-ttu-id="febd3-132">Uso di transazioni esistenti</span><span class="sxs-lookup"><span data-stu-id="febd3-132">Using Existing Transactions</span></span>  
 <span data-ttu-id="febd3-133">È possibile specificare un oggetto <xref:System.Data.SqlClient.SqlTransaction> esistente come parametro in un costruttore <xref:System.Data.SqlClient.SqlBulkCopy>.</span><span class="sxs-lookup"><span data-stu-id="febd3-133">You can specify an existing <xref:System.Data.SqlClient.SqlTransaction> object as a parameter in a <xref:System.Data.SqlClient.SqlBulkCopy> constructor.</span></span> <span data-ttu-id="febd3-134">In questa situazione l'operazione di copia bulk viene eseguita in una transazione esistente e non viene apportata alcuna modifica allo stato della transazione, ovvero non ne viene eseguito il commit o l'annullamento.</span><span class="sxs-lookup"><span data-stu-id="febd3-134">In this situation, the bulk copy operation is performed in an existing transaction, and no change is made to the transaction state (that is, it is neither committed nor aborted).</span></span> <span data-ttu-id="febd3-135">Questo consente a un'applicazione di includere l'operazione di copia di massa in una transazione con altre operazioni di database.</span><span class="sxs-lookup"><span data-stu-id="febd3-135">This allows an application to include the bulk copy operation in a transaction with other database operations.</span></span> <span data-ttu-id="febd3-136">Tuttavia, se non viene specificato un oggetto <xref:System.Data.SqlClient.SqlTransaction>, se non viene passato un riferimento null e se nella connessione è presente una transazione attiva, verrà generata un'eccezione.</span><span class="sxs-lookup"><span data-stu-id="febd3-136">However, if you do not specify a <xref:System.Data.SqlClient.SqlTransaction> object and pass a null reference, and the connection has an active transaction, an exception is thrown.</span></span>  
  
 <span data-ttu-id="febd3-137">Se è necessario eseguire il rollback dell'intera operazione di copia di massa perché si verifica un errore oppure se è necessario eseguire tale copia come parte di un processo di dimensioni maggiori di cui si può eseguire il rollback, è possibile fornire un oggetto <xref:System.Data.SqlClient.SqlTransaction> al costruttore <xref:System.Data.SqlClient.SqlBulkCopy>.</span><span class="sxs-lookup"><span data-stu-id="febd3-137">If you need to roll back the entire bulk copy operation because an error occurs, or if the bulk copy should execute as part of a larger process that can be rolled back, you can provide a <xref:System.Data.SqlClient.SqlTransaction> object to the <xref:System.Data.SqlClient.SqlBulkCopy> constructor.</span></span>  
  
 <span data-ttu-id="febd3-138">La seguente applicazione console è analoga al primo esempio (non transazionale), con una sola eccezione: in questo esempio l'operazione di copia di massa è inclusa in una transazione esterna di dimensioni maggiori.</span><span class="sxs-lookup"><span data-stu-id="febd3-138">The following console application is similar to the first (non-transacted) example, with one exception: in this example, the bulk copy operation is included in a larger, external transaction.</span></span> <span data-ttu-id="febd3-139">Quando si verifica l'errore di violazione della chiave primaria, viene eseguito il rollback dell'intera transazione e non viene aggiunta alcuna riga alla tabella di destinazione.</span><span class="sxs-lookup"><span data-stu-id="febd3-139">When the primary key violation error occurs, the entire transaction is rolled back and no rows are added to the destination table.</span></span>  
  
> [!IMPORTANT]
> <span data-ttu-id="febd3-140">Questo esempio non verrà eseguito a meno che non siano state create le tabelle di lavoro come descritto in configurazione di esempio per la [copia bulk](bulk-copy-example-setup.md).</span><span class="sxs-lookup"><span data-stu-id="febd3-140">This sample will not run unless you have created the work tables as described in [Bulk Copy Example Setup](bulk-copy-example-setup.md).</span></span> <span data-ttu-id="febd3-141">Questo codice viene fornito per illustrare la sintassi per l'utilizzo solo di **SqlBulkCopy** .</span><span class="sxs-lookup"><span data-stu-id="febd3-141">This code is provided to demonstrate the syntax for using **SqlBulkCopy** only.</span></span> <span data-ttu-id="febd3-142">Se le tabelle di origine e di destinazione si trovano nella stessa istanza di SQL Server, è più semplice e veloce utilizzare un'istruzione Transact`INSERT … SELECT` -SQL per copiare i dati.</span><span class="sxs-lookup"><span data-stu-id="febd3-142">If the source and destination tables are located in the same SQL Server instance, it is easier and faster to use a Transact-SQL`INSERT … SELECT` statement to copy the data.</span></span>  
  
 [!code-csharp[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/csharp/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/CS/source.cs#1)]
 [!code-vb[DataWorks SqlBulkCopy.SqlTransaction#1](../../../../../samples/snippets/visualbasic/VS_Snippets_ADO.NET/DataWorks SqlBulkCopy.SqlTransaction/VB/source.vb#1)]  
  
## <a name="see-also"></a><span data-ttu-id="febd3-143">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="febd3-143">See also</span></span>

- [<span data-ttu-id="febd3-144">Operazioni di copia di massa in SQL Server</span><span class="sxs-lookup"><span data-stu-id="febd3-144">Bulk Copy Operations in SQL Server</span></span>](bulk-copy-operations-in-sql-server.md)
- [<span data-ttu-id="febd3-145">Panoramica di ADO.NET</span><span class="sxs-lookup"><span data-stu-id="febd3-145">ADO.NET Overview</span></span>](../ado-net-overview.md)
